/* global PouchDB */
/* jshint -W079 */
'use strict';

var testUtils = {};

function uniq(list) {
  var map = {};
  list.forEach(function (item) {
    map[item] = true;
  });
  return Object.keys(map);
}

testUtils.isCouchMaster = function () {
  return 'SERVER' in testUtils.params() &&
    testUtils.params().SERVER === 'couchdb-master';
};

testUtils.isSyncGateway = function () {
  return 'SERVER' in testUtils.params() &&
    testUtils.params().SERVER === 'sync-gateway';
};

testUtils.isExpressRouter = function () {
  return 'SERVER' in testUtils.params() &&
    testUtils.params().SERVER === 'pouchdb-express-router';
};

testUtils.params = function () {
  if (typeof module !== 'undefined' && module.exports) {
    return process.env;
  }
  var paramStr = document.location.search.slice(1);
  return paramStr.split('&').reduce(function (acc, val) {
    if (!val) {
      return acc;
    }
    var tmp = val.split('=');
    acc[tmp[0]] = decodeURIComponent(tmp[1]) || true;
    return acc;
  }, {});
};

testUtils.couchHost = function () {
  if (typeof window !== 'undefined' && window.cordova) {
    // magic route to localhost on android emulator
    return 'http://10.0.2.2:5984';
  }

  if (typeof window !== 'undefined' && window.COUCH_HOST) {
    return window.COUCH_HOST;
  }

  if (typeof process !== 'undefined' && process.env.COUCH_HOST) {
    return process.env.COUCH_HOST;
  }

  if ('couchHost' in testUtils.params()) {
    return testUtils.params().couchHost;
  }

  return 'http://localhost:5984';
};

// Abstracts constructing a Blob object, so it also works in older
// browsers that don't support the native Blob constructor (e.g.
// old QtWebKit versions, Android < 4.4).
// Copied over from createBlob.js in PouchDB because we don't
// want to have to export this function in utils
function createBlob(parts, properties) {
  /* global BlobBuilder,MSBlobBuilder,MozBlobBuilder,WebKitBlobBuilder */
  parts = parts || [];
  properties = properties || {};
  try {
    return new Blob(parts, properties);
  } catch (e) {
    if (e.name !== "TypeError") {
      throw e;
    }
    var Builder = typeof BlobBuilder !== 'undefined' ? BlobBuilder :
                  typeof MSBlobBuilder !== 'undefined' ? MSBlobBuilder :
                  typeof MozBlobBuilder !== 'undefined' ? MozBlobBuilder :
                  WebKitBlobBuilder;
    var builder = new Builder();
    for (var i = 0; i < parts.length; i += 1) {
      builder.append(parts[i]);
    }
    return builder.getBlob(properties.type);
  }
}

testUtils.makeBlob = function (data, type) {
  if (typeof module !== 'undefined' && module.exports) {
    return new Buffer(data, 'binary');
  } else {
    return createBlob([data], {
      type: (type || 'text/plain')
    });
  }
};

function typedBuffer(binString, buffType, type) {
  // buffType is either 'binary' or 'base64'
  var buff = new Buffer(binString, buffType);
  buff.type = type; // non-standard, but used for consistency with the browser
  return buff;
}

// Abstracts constructing a Blob object, so it also works in older
// browsers that don't support the native Blob constructor (e.g.
// old QtWebKit versions, Android < 4.4).
function createBlob(parts, properties) {
  /* global BlobBuilder,MSBlobBuilder,MozBlobBuilder,WebKitBlobBuilder */
  parts = parts || [];
  properties = properties || {};
  try {
    return new Blob(parts, properties);
  } catch (e) {
    if (e.name !== "TypeError") {
      throw e;
    }
    var Builder = typeof BlobBuilder !== 'undefined' ? BlobBuilder :
      typeof MSBlobBuilder !== 'undefined' ? MSBlobBuilder :
        typeof MozBlobBuilder !== 'undefined' ? MozBlobBuilder :
          WebKitBlobBuilder;
    var builder = new Builder();
    for (var i = 0; i < parts.length; i += 1) {
      builder.append(parts[i]);
    }
    return builder.getBlob(properties.type);
  }
}

// From http://stackoverflow.com/questions/14967647/ (continues on next line)
// encode-decode-image-with-base64-breaks-image (2013-04-21)
function binaryStringToArrayBuffer(bin) {
  var length = bin.length;
  var buf = new ArrayBuffer(length);
  var arr = new Uint8Array(buf);
  for (var i = 0; i < length; i++) {
    arr[i] = bin.charCodeAt(i);
  }
  return buf;
}

function binStringToBlufferBrowser(binString, type) {
  return createBlob([binaryStringToArrayBuffer(binString)], {type: type});
}

function binStringToBlufferNode(binString, type) {
  return typedBuffer(binString, 'binary', type);
}

testUtils.binaryStringToBlob = function (bin, type) {
  if (typeof process === 'undefined' || process.browser) {
    return binStringToBlufferBrowser(bin, type);
  }
  return binStringToBlufferNode(bin, type);
};

testUtils.btoa = function (arg) {
  if (typeof process === 'undefined' || process.browser) {
    return btoa(arg);
  }
  return new Buffer(str, 'binary').toString('base64');
};

testUtils.atob = function (arg) {
  if (typeof process === 'undefined' || process.browser) {
    return atob(arg);
  }

  var base64 = new Buffer(str, 'base64');
  // Node.js will just skip the characters it can't decode instead of
  // throwing an exception
  if (base64.toString('base64') !== str) {
    throw new Error("attachment is not a valid base64 string");
  }
  return base64.toString('binary');
};

testUtils.readBlob = function (blob, callback) {
  if (typeof module !== 'undefined' && module.exports) {
    callback(blob.toString('binary'));
  } else {
    var reader = new FileReader();
    reader.onloadend = function () {
      
      var binary = "";
      var bytes = new Uint8Array(this.result || '');
      var length = bytes.byteLength;
      
      for (var i = 0; i < length; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      
      callback(binary);
    };
    reader.readAsArrayBuffer(blob);
  }
};

testUtils.readBlobPromise = function (blob) {
  return new testUtils.Promise(function (resolve) {
    testUtils.readBlob(blob, resolve);
  });
};

testUtils.base64Blob = function (blob, callback) {
  if (typeof module !== 'undefined' && module.exports) {
    callback(blob.toString('base64'));
  } else {
    testUtils.readBlob(blob, function (binary) {
      callback(testUtils.btoa(binary));
    });
  }
};

// Prefix http adapter database names with their host and
// node adapter ones with a db location
testUtils.adapterUrl = function (adapter, name) {
  if (adapter === 'http') {
    return testUtils.couchHost() + '/' + name;
  }
  return name;
};

// Delete specified databases
testUtils.cleanup = function (dbs, done) {
  dbs = uniq(dbs);
  var num = dbs.length;
  var finished = function () {
    if (--num === 0) {
      done();
    }
  };

  dbs.forEach(function (db) {
    new PouchDB(db).destroy(finished, finished);
  });
};

// Put doc after prevRev (so that doc is a child of prevDoc
// in rev_tree). Doc must have _rev. If prevRev is not specified
// just insert doc with correct _rev (new_edits=false!)
testUtils.putAfter = function (db, doc, prevRev, callback) {
  var newDoc = testUtils.extend({}, doc);
  if (!prevRev) {
    db.put(newDoc, { new_edits: false }, callback);
    return;
  }
  newDoc._revisions = {
    start: +newDoc._rev.split('-')[0],
    ids: [
      newDoc._rev.split('-')[1],
      prevRev.split('-')[1]
    ]
  };
  db.put(newDoc, { new_edits: false }, callback);
};

// docs will be inserted one after another
// starting from root
testUtils.putBranch = function (db, docs, callback) {
  function insert(i) {
    var doc = docs[i];
    var prev = i > 0 ? docs[i - 1]._rev : null;
    function next() {
      if (i < docs.length - 1) {
        insert(i + 1);
      } else {
        callback();
      }
    }
    db.get(doc._id, { rev: doc._rev }, function (err) {
      if (err) {
        testUtils.putAfter(db, docs[i], prev, function () {
          next();
        });
      } else {
        next();
      }
    });
  }
  insert(0);
};

testUtils.putTree = function (db, tree, callback) {
  function insert(i) {
    var branch = tree[i];
    testUtils.putBranch(db, branch, function () {
      if (i < tree.length - 1) {
        insert(i + 1);
      } else {
        callback();
      }
    });
  }
  insert(0);
};

testUtils.isCouchDB = function (cb) {
  PouchDB.ajax({url: testUtils.couchHost() + '/' }, function (err, res) {
    cb('couchdb' in res);
  });
};

testUtils.writeDocs = function (db, docs, callback, res) {
  if (!res) {
    res = [];
  }
  if (!docs.length) {
    return callback(null, res);
  }
  var doc = docs.shift();
  db.put(doc, function (err, info) {
    res.push(info);
    testUtils.writeDocs(db, docs, callback, res);
  });
};

// Borrowed from: http://stackoverflow.com/a/840849
testUtils.eliminateDuplicates = function (arr) {
  var i, element, len = arr.length, out = [], obj = {};
  for (i = 0; i < len; i++) {
    obj[arr[i]] = 0;
  }
  for (element in obj) {
    if (obj.hasOwnProperty(element)) {
      out.push(element);
    }
  }
  return out;
};

// Promise finally util similar to Q.finally
testUtils.fin = function (promise, cb) {
  return promise.then(function (res) {
    var promise2 = cb();
    if (typeof promise2.then === 'function') {
      return promise2.then(function () {
        return res;
      });
    }
    return res;
  }, function (reason) {
    var promise2 = cb();
    if (typeof promise2.then === 'function') {
      return promise2.then(function () {
        throw reason;
      });
    }
    throw reason;
  });
};

testUtils.promisify = function (fun, context) {
  return function () {
    var args = [];
    for (var i = 0; i < arguments.length; i++) {
      args[i] = arguments[i];
    }
    return new testUtils.Promise(function (resolve, reject) {
      args.push(function (err, res) {
        if (err) {
          return reject(err);
        }
        return resolve(res);
      });
      fun.apply(context, args);
    });
  };
};

// testUtils.Promise = require('lie');
!function e(t,n,r){function o(u,s){if(!n[u]){if(!t[u]){var c="function"==typeof require&&require;if(!s&&c)return c(u,!0);if(i)return i(u,!0);var a=new Error("Cannot find module '"+u+"'");throw a.code="MODULE_NOT_FOUND",a}var l=n[u]={exports:{}};t[u][0].call(l.exports,function(e){var n=t[u][1][e];return o(n?n:e)},l,l.exports,e,t,n,r)}return n[u].exports}for(var i="function"==typeof require&&require,u=0;u<r.length;u++)o(r[u]);return o}({1:[function(e,t,n){testUtils.Promise=e("lie")},{lie:3}],2:[function(e,t,n){(function(e){"use strict";function n(){l=!0;for(var e,t,n=f.length;n;){for(t=f,f=[],e=-1;++e<n;)t[e]();n=f.length}l=!1}function r(e){1!==f.push(e)||l||o()}var o,i=e.MutationObserver||e.WebKitMutationObserver;if(i){var u=0,s=new i(n),c=e.document.createTextNode("");s.observe(c,{characterData:!0}),o=function(){c.data=u=++u%2}}else if(e.setImmediate||"undefined"==typeof e.MessageChannel)o="document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var t=e.document.createElement("script");t.onreadystatechange=function(){n(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null},e.document.documentElement.appendChild(t)}:function(){setTimeout(n,0)};else{var a=new e.MessageChannel;a.port1.onmessage=n,o=function(){a.port2.postMessage(0)}}var l,f=[];t.exports=r}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],3:[function(e,t,n){"use strict";function r(){}function o(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=j,this.queue=[],this.outcome=void 0,e!==r&&c(this,e)}function i(e,t,n){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof n&&(this.onRejected=n,this.callRejected=this.otherCallRejected)}function u(e,t,n){v(function(){var r;try{r=t(n)}catch(o){return d.reject(e,o)}r===e?d.reject(e,new TypeError("Cannot resolve promise with itself")):d.resolve(e,r)})}function s(e){var t=e&&e.then;return e&&"object"==typeof e&&"function"==typeof t?function(){t.apply(e,arguments)}:void 0}function c(e,t){function n(t){i||(i=!0,d.reject(e,t))}function r(t){i||(i=!0,d.resolve(e,t))}function o(){t(r,n)}var i=!1,u=a(o);"error"===u.status&&n(u.value)}function a(e,t){var n={};try{n.value=e(t),n.status="success"}catch(r){n.status="error",n.value=r}return n}function l(e){return e instanceof this?e:d.resolve(new this(r),e)}function f(e){var t=new this(r);return d.reject(t,e)}function h(e){function t(e,t){function r(e){u[t]=e,++s!==o||i||(i=!0,d.resolve(a,u))}n.resolve(e).then(r,function(e){i||(i=!0,d.reject(a,e))})}var n=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var o=e.length,i=!1;if(!o)return this.resolve([]);for(var u=new Array(o),s=0,c=-1,a=new this(r);++c<o;)t(e[c],c);return a}function p(e){function t(e){n.resolve(e).then(function(e){i||(i=!0,d.resolve(s,e))},function(e){i||(i=!0,d.reject(s,e))})}var n=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var o=e.length,i=!1;if(!o)return this.resolve([]);for(var u=-1,s=new this(r);++u<o;)t(e[u]);return s}var v=e("immediate"),d={},y=["REJECTED"],m=["FULFILLED"],j=["PENDING"];t.exports=o,o.prototype["catch"]=function(e){return this.then(null,e)},o.prototype.then=function(e,t){if("function"!=typeof e&&this.state===m||"function"!=typeof t&&this.state===y)return this;var n=new this.constructor(r);if(this.state!==j){var o=this.state===m?e:t;u(n,o,this.outcome)}else this.queue.push(new i(n,e,t));return n},i.prototype.callFulfilled=function(e){d.resolve(this.promise,e)},i.prototype.otherCallFulfilled=function(e){u(this.promise,this.onFulfilled,e)},i.prototype.callRejected=function(e){d.reject(this.promise,e)},i.prototype.otherCallRejected=function(e){u(this.promise,this.onRejected,e)},d.resolve=function(e,t){var n=a(s,t);if("error"===n.status)return d.reject(e,n.value);var r=n.value;if(r)c(e,r);else{e.state=m,e.outcome=t;for(var o=-1,i=e.queue.length;++o<i;)e.queue[o].callFulfilled(t)}return e},d.reject=function(e,t){e.state=y,e.outcome=t;for(var n=-1,r=e.queue.length;++n<r;)e.queue[n].callRejected(t);return e},o.resolve=l,o.reject=f,o.all=h,o.race=p},{immediate:2}]},{},[1]);

// testUtils.extend = require('js-extend').extend;
!function t(r,e,n){function o(f,c){if(!e[f]){if(!r[f]){var u="function"==typeof require&&require;if(!c&&u)return u(f,!0);if(i)return i(f,!0);var a=new Error("Cannot find module '"+f+"'");throw a.code="MODULE_NOT_FOUND",a}var l=e[f]={exports:{}};r[f][0].call(l.exports,function(t){var e=r[f][1][t];return o(e?e:t)},l,l.exports,t,r,e,n)}return e[f].exports}for(var i="function"==typeof require&&require,f=0;f<n.length;f++)o(n[f]);return o}({1:[function(t,r,e){testUtils.extend=t("js-extend").extend},{"js-extend":2}],2:[function(t,r,e){(function(t){t("object"==typeof e?e:this)}).call(this,function(t){var r=Array.prototype.slice,e=Array.prototype.forEach,n=function(t){if("object"!=typeof t)throw t+" is not an object";var o=r.call(arguments,1);return e.call(o,function(r){if(r)for(var e in r)"object"==typeof r[e]&&t[e]?n.call(t,t[e],r[e]):t[e]=r[e]}),t};t.extend=n})},{}]},{},[1]);

// testUtils.ajax = require('pouchdb/extras/ajax')
!function e(t,r,n){function o(s,a){if(!r[s]){if(!t[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(i)return i(s,!0);var f=new Error("Cannot find module '"+s+"'");throw f.code="MODULE_NOT_FOUND",f}var c=r[s]={exports:{}};t[s][0].call(c.exports,function(e){var r=t[s][1][e];return o(r?r:e)},c,c.exports,e,t,r,n)}return r[s].exports}for(var i="function"==typeof require&&require,s=0;s<n.length;s++)o(n[s]);return o}({1:[function(e,t,r){var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";!function(e){"use strict";function t(e){var t=e.charCodeAt(0);return t===s||t===h?62:t===a||t===l?63:u>t?-1:u+10>t?t-u+26+26:c+26>t?t-c:f+26>t?t-f+26:void 0}function r(e){function r(e){f[h++]=e}var n,o,s,a,u,f;if(e.length%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var c=e.length;u="="===e.charAt(c-2)?2:"="===e.charAt(c-1)?1:0,f=new i(3*e.length/4-u),s=u>0?e.length-4:e.length;var h=0;for(n=0,o=0;s>n;n+=4,o+=3)a=t(e.charAt(n))<<18|t(e.charAt(n+1))<<12|t(e.charAt(n+2))<<6|t(e.charAt(n+3)),r((16711680&a)>>16),r((65280&a)>>8),r(255&a);return 2===u?(a=t(e.charAt(n))<<2|t(e.charAt(n+1))>>4,r(255&a)):1===u&&(a=t(e.charAt(n))<<10|t(e.charAt(n+1))<<4|t(e.charAt(n+2))>>2,r(a>>8&255),r(255&a)),f}function o(e){function t(e){return n.charAt(e)}function r(e){return t(e>>18&63)+t(e>>12&63)+t(e>>6&63)+t(63&e)}var o,i,s,a=e.length%3,u="";for(o=0,s=e.length-a;s>o;o+=3)i=(e[o]<<16)+(e[o+1]<<8)+e[o+2],u+=r(i);switch(a){case 1:i=e[e.length-1],u+=t(i>>2),u+=t(i<<4&63),u+="==";break;case 2:i=(e[e.length-2]<<8)+e[e.length-1],u+=t(i>>10),u+=t(i>>4&63),u+=t(i<<2&63),u+="="}return u}var i="undefined"!=typeof Uint8Array?Uint8Array:Array,s="+".charCodeAt(0),a="/".charCodeAt(0),u="0".charCodeAt(0),f="a".charCodeAt(0),c="A".charCodeAt(0),h="-".charCodeAt(0),l="_".charCodeAt(0);e.toByteArray=r,e.fromByteArray=o}("undefined"==typeof r?this.base64js={}:r)},{}],2:[function(e,t,r){(function(t){function n(){function e(){}try{var t=new Uint8Array(1);return t.foo=function(){return 42},t.constructor=e,42===t.foo()&&t.constructor===e&&"function"==typeof t.subarray&&0===t.subarray(1,1).byteLength}catch(r){return!1}}function o(){return i.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function i(e){return this instanceof i?(this.length=0,this.parent=void 0,"number"==typeof e?s(this,e):"string"==typeof e?a(this,e,arguments.length>1?arguments[1]:"utf8"):u(this,e)):arguments.length>1?new i(e,arguments[1]):new i(e)}function s(e,t){if(e=y(e,0>t?0:0|v(t)),!i.TYPED_ARRAY_SUPPORT)for(var r=0;t>r;r++)e[r]=0;return e}function a(e,t,r){("string"!=typeof r||""===r)&&(r="utf8");var n=0|m(t,r);return e=y(e,n),e.write(t,r),e}function u(e,t){if(i.isBuffer(t))return f(e,t);if($(t))return c(e,t);if(null==t)throw new TypeError("must start with number, buffer, array or string");if("undefined"!=typeof ArrayBuffer){if(t.buffer instanceof ArrayBuffer)return h(e,t);if(t instanceof ArrayBuffer)return l(e,t)}return t.length?p(e,t):d(e,t)}function f(e,t){var r=0|v(t.length);return e=y(e,r),t.copy(e,0,0,r),e}function c(e,t){var r=0|v(t.length);e=y(e,r);for(var n=0;r>n;n+=1)e[n]=255&t[n];return e}function h(e,t){var r=0|v(t.length);e=y(e,r);for(var n=0;r>n;n+=1)e[n]=255&t[n];return e}function l(e,t){return i.TYPED_ARRAY_SUPPORT?(t.byteLength,e=i._augment(new Uint8Array(t))):e=h(e,new Uint8Array(t)),e}function p(e,t){var r=0|v(t.length);e=y(e,r);for(var n=0;r>n;n+=1)e[n]=255&t[n];return e}function d(e,t){var r,n=0;"Buffer"===t.type&&$(t.data)&&(r=t.data,n=0|v(r.length)),e=y(e,n);for(var o=0;n>o;o+=1)e[o]=255&r[o];return e}function y(e,t){i.TYPED_ARRAY_SUPPORT?(e=i._augment(new Uint8Array(t)),e.__proto__=i.prototype):(e.length=t,e._isBuffer=!0);var r=0!==t&&t<=i.poolSize>>>1;return r&&(e.parent=K),e}function v(e){if(e>=o())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+o().toString(16)+" bytes");return 0|e}function g(e,t){if(!(this instanceof g))return new g(e,t);var r=new i(e,t);return delete r.parent,r}function m(e,t){"string"!=typeof e&&(e=""+e);var r=e.length;if(0===r)return 0;for(var n=!1;;)switch(t){case"ascii":case"binary":case"raw":case"raws":return r;case"utf8":case"utf-8":return V(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return z(e).length;default:if(n)return V(e).length;t=(""+t).toLowerCase(),n=!0}}function _(e,t,r){var n=!1;if(t=0|t,r=void 0===r||r===1/0?this.length:0|r,e||(e="utf8"),0>t&&(t=0),r>this.length&&(r=this.length),t>=r)return"";for(;;)switch(e){case"hex":return O(this,t,r);case"utf8":case"utf-8":return S(this,t,r);case"ascii":return T(this,t,r);case"binary":return U(this,t,r);case"base64":return B(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return C(this,t,r);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function b(e,t,r,n){r=Number(r)||0;var o=e.length-r;n?(n=Number(n),n>o&&(n=o)):n=o;var i=t.length;if(i%2!==0)throw new Error("Invalid hex string");n>i/2&&(n=i/2);for(var s=0;n>s;s++){var a=parseInt(t.substr(2*s,2),16);if(isNaN(a))throw new Error("Invalid hex string");e[r+s]=a}return s}function w(e,t,r,n){return Q(V(t,e.length-r),e,r,n)}function E(e,t,r,n){return Q(G(t),e,r,n)}function A(e,t,r,n){return E(e,t,r,n)}function I(e,t,r,n){return Q(z(t),e,r,n)}function R(e,t,r,n){return Q(J(t,e.length-r),e,r,n)}function B(e,t,r){return 0===t&&r===e.length?H.fromByteArray(e):H.fromByteArray(e.slice(t,r))}function S(e,t,r){r=Math.min(e.length,r);for(var n=[],o=t;r>o;){var i=e[o],s=null,a=i>239?4:i>223?3:i>191?2:1;if(r>=o+a){var u,f,c,h;switch(a){case 1:128>i&&(s=i);break;case 2:u=e[o+1],128===(192&u)&&(h=(31&i)<<6|63&u,h>127&&(s=h));break;case 3:u=e[o+1],f=e[o+2],128===(192&u)&&128===(192&f)&&(h=(15&i)<<12|(63&u)<<6|63&f,h>2047&&(55296>h||h>57343)&&(s=h));break;case 4:u=e[o+1],f=e[o+2],c=e[o+3],128===(192&u)&&128===(192&f)&&128===(192&c)&&(h=(15&i)<<18|(63&u)<<12|(63&f)<<6|63&c,h>65535&&1114112>h&&(s=h))}}null===s?(s=65533,a=1):s>65535&&(s-=65536,n.push(s>>>10&1023|55296),s=56320|1023&s),n.push(s),o+=a}return L(n)}function L(e){var t=e.length;if(X>=t)return String.fromCharCode.apply(String,e);for(var r="",n=0;t>n;)r+=String.fromCharCode.apply(String,e.slice(n,n+=X));return r}function T(e,t,r){var n="";r=Math.min(e.length,r);for(var o=t;r>o;o++)n+=String.fromCharCode(127&e[o]);return n}function U(e,t,r){var n="";r=Math.min(e.length,r);for(var o=t;r>o;o++)n+=String.fromCharCode(e[o]);return n}function O(e,t,r){var n=e.length;(!t||0>t)&&(t=0),(!r||0>r||r>n)&&(r=n);for(var o="",i=t;r>i;i++)o+=q(e[i]);return o}function C(e,t,r){for(var n=e.slice(t,r),o="",i=0;i<n.length;i+=2)o+=String.fromCharCode(n[i]+256*n[i+1]);return o}function D(e,t,r){if(e%1!==0||0>e)throw new RangeError("offset is not uint");if(e+t>r)throw new RangeError("Trying to access beyond buffer length")}function x(e,t,r,n,o,s){if(!i.isBuffer(e))throw new TypeError("buffer must be a Buffer instance");if(t>o||s>t)throw new RangeError("value is out of bounds");if(r+n>e.length)throw new RangeError("index out of range")}function N(e,t,r,n){0>t&&(t=65535+t+1);for(var o=0,i=Math.min(e.length-r,2);i>o;o++)e[r+o]=(t&255<<8*(n?o:1-o))>>>8*(n?o:1-o)}function j(e,t,r,n){0>t&&(t=4294967295+t+1);for(var o=0,i=Math.min(e.length-r,4);i>o;o++)e[r+o]=t>>>8*(n?o:3-o)&255}function P(e,t,r,n,o,i){if(t>o||i>t)throw new RangeError("value is out of bounds");if(r+n>e.length)throw new RangeError("index out of range");if(0>r)throw new RangeError("index out of range")}function k(e,t,r,n,o){return o||P(e,t,r,4,3.4028234663852886e38,-3.4028234663852886e38),W.write(e,t,r,n,23,4),r+4}function M(e,t,r,n,o){return o||P(e,t,r,8,1.7976931348623157e308,-1.7976931348623157e308),W.write(e,t,r,n,52,8),r+8}function F(e){if(e=Y(e).replace(ee,""),e.length<2)return"";for(;e.length%4!==0;)e+="=";return e}function Y(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}function q(e){return 16>e?"0"+e.toString(16):e.toString(16)}function V(e,t){t=t||1/0;for(var r,n=e.length,o=null,i=[],s=0;n>s;s++){if(r=e.charCodeAt(s),r>55295&&57344>r){if(!o){if(r>56319){(t-=3)>-1&&i.push(239,191,189);continue}if(s+1===n){(t-=3)>-1&&i.push(239,191,189);continue}o=r;continue}if(56320>r){(t-=3)>-1&&i.push(239,191,189),o=r;continue}r=o-55296<<10|r-56320|65536}else o&&(t-=3)>-1&&i.push(239,191,189);if(o=null,128>r){if((t-=1)<0)break;i.push(r)}else if(2048>r){if((t-=2)<0)break;i.push(r>>6|192,63&r|128)}else if(65536>r){if((t-=3)<0)break;i.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(1114112>r))throw new Error("Invalid code point");if((t-=4)<0)break;i.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return i}function G(e){for(var t=[],r=0;r<e.length;r++)t.push(255&e.charCodeAt(r));return t}function J(e,t){for(var r,n,o,i=[],s=0;s<e.length&&!((t-=2)<0);s++)r=e.charCodeAt(s),n=r>>8,o=r%256,i.push(o),i.push(n);return i}function z(e){return H.toByteArray(F(e))}function Q(e,t,r,n){for(var o=0;n>o&&!(o+r>=t.length||o>=e.length);o++)t[o+r]=e[o];return o}var H=e("base64-js"),W=e("ieee754"),$=e("is-array");r.Buffer=i,r.SlowBuffer=g,r.INSPECT_MAX_BYTES=50,i.poolSize=8192;var K={};i.TYPED_ARRAY_SUPPORT=void 0!==t.TYPED_ARRAY_SUPPORT?t.TYPED_ARRAY_SUPPORT:n(),i.TYPED_ARRAY_SUPPORT&&(i.prototype.__proto__=Uint8Array.prototype,i.__proto__=Uint8Array),i.isBuffer=function(e){return!(null==e||!e._isBuffer)},i.compare=function(e,t){if(!i.isBuffer(e)||!i.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var r=e.length,n=t.length,o=0,s=Math.min(r,n);s>o&&e[o]===t[o];)++o;return o!==s&&(r=e[o],n=t[o]),n>r?-1:r>n?1:0},i.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},i.concat=function(e,t){if(!$(e))throw new TypeError("list argument must be an Array of Buffers.");if(0===e.length)return new i(0);var r;if(void 0===t)for(t=0,r=0;r<e.length;r++)t+=e[r].length;var n=new i(t),o=0;for(r=0;r<e.length;r++){var s=e[r];s.copy(n,o),o+=s.length}return n},i.byteLength=m,i.prototype.length=void 0,i.prototype.parent=void 0,i.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?S(this,0,e):_.apply(this,arguments)},i.prototype.equals=function(e){if(!i.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e?!0:0===i.compare(this,e)},i.prototype.inspect=function(){var e="",t=r.INSPECT_MAX_BYTES;return this.length>0&&(e=this.toString("hex",0,t).match(/.{2}/g).join(" "),this.length>t&&(e+=" ... ")),"<Buffer "+e+">"},i.prototype.compare=function(e){if(!i.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e?0:i.compare(this,e)},i.prototype.indexOf=function(e,t){function r(e,t,r){for(var n=-1,o=0;r+o<e.length;o++)if(e[r+o]===t[-1===n?0:o-n]){if(-1===n&&(n=o),o-n+1===t.length)return r+n}else n=-1;return-1}if(t>2147483647?t=2147483647:-2147483648>t&&(t=-2147483648),t>>=0,0===this.length)return-1;if(t>=this.length)return-1;if(0>t&&(t=Math.max(this.length+t,0)),"string"==typeof e)return 0===e.length?-1:String.prototype.indexOf.call(this,e,t);if(i.isBuffer(e))return r(this,e,t);if("number"==typeof e)return i.TYPED_ARRAY_SUPPORT&&"function"===Uint8Array.prototype.indexOf?Uint8Array.prototype.indexOf.call(this,e,t):r(this,[e],t);throw new TypeError("val must be string, number or Buffer")},i.prototype.get=function(e){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(e)},i.prototype.set=function(e,t){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(e,t)},i.prototype.write=function(e,t,r,n){if(void 0===t)n="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)n=t,r=this.length,t=0;else if(isFinite(t))t=0|t,isFinite(r)?(r=0|r,void 0===n&&(n="utf8")):(n=r,r=void 0);else{var o=n;n=t,t=0|r,r=o}var i=this.length-t;if((void 0===r||r>i)&&(r=i),e.length>0&&(0>r||0>t)||t>this.length)throw new RangeError("attempt to write outside buffer bounds");n||(n="utf8");for(var s=!1;;)switch(n){case"hex":return b(this,e,t,r);case"utf8":case"utf-8":return w(this,e,t,r);case"ascii":return E(this,e,t,r);case"binary":return A(this,e,t,r);case"base64":return I(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return R(this,e,t,r);default:if(s)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),s=!0}},i.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var X=4096;i.prototype.slice=function(e,t){var r=this.length;e=~~e,t=void 0===t?r:~~t,0>e?(e+=r,0>e&&(e=0)):e>r&&(e=r),0>t?(t+=r,0>t&&(t=0)):t>r&&(t=r),e>t&&(t=e);var n;if(i.TYPED_ARRAY_SUPPORT)n=i._augment(this.subarray(e,t));else{var o=t-e;n=new i(o,void 0);for(var s=0;o>s;s++)n[s]=this[s+e]}return n.length&&(n.parent=this.parent||this),n},i.prototype.readUIntLE=function(e,t,r){e=0|e,t=0|t,r||D(e,t,this.length);for(var n=this[e],o=1,i=0;++i<t&&(o*=256);)n+=this[e+i]*o;return n},i.prototype.readUIntBE=function(e,t,r){e=0|e,t=0|t,r||D(e,t,this.length);for(var n=this[e+--t],o=1;t>0&&(o*=256);)n+=this[e+--t]*o;return n},i.prototype.readUInt8=function(e,t){return t||D(e,1,this.length),this[e]},i.prototype.readUInt16LE=function(e,t){return t||D(e,2,this.length),this[e]|this[e+1]<<8},i.prototype.readUInt16BE=function(e,t){return t||D(e,2,this.length),this[e]<<8|this[e+1]},i.prototype.readUInt32LE=function(e,t){return t||D(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},i.prototype.readUInt32BE=function(e,t){return t||D(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},i.prototype.readIntLE=function(e,t,r){e=0|e,t=0|t,r||D(e,t,this.length);for(var n=this[e],o=1,i=0;++i<t&&(o*=256);)n+=this[e+i]*o;return o*=128,n>=o&&(n-=Math.pow(2,8*t)),n},i.prototype.readIntBE=function(e,t,r){e=0|e,t=0|t,r||D(e,t,this.length);for(var n=t,o=1,i=this[e+--n];n>0&&(o*=256);)i+=this[e+--n]*o;return o*=128,i>=o&&(i-=Math.pow(2,8*t)),i},i.prototype.readInt8=function(e,t){return t||D(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},i.prototype.readInt16LE=function(e,t){t||D(e,2,this.length);var r=this[e]|this[e+1]<<8;return 32768&r?4294901760|r:r},i.prototype.readInt16BE=function(e,t){t||D(e,2,this.length);var r=this[e+1]|this[e]<<8;return 32768&r?4294901760|r:r},i.prototype.readInt32LE=function(e,t){return t||D(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},i.prototype.readInt32BE=function(e,t){return t||D(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},i.prototype.readFloatLE=function(e,t){return t||D(e,4,this.length),W.read(this,e,!0,23,4)},i.prototype.readFloatBE=function(e,t){return t||D(e,4,this.length),W.read(this,e,!1,23,4)},i.prototype.readDoubleLE=function(e,t){return t||D(e,8,this.length),W.read(this,e,!0,52,8)},i.prototype.readDoubleBE=function(e,t){return t||D(e,8,this.length),W.read(this,e,!1,52,8)},i.prototype.writeUIntLE=function(e,t,r,n){e=+e,t=0|t,r=0|r,n||x(this,e,t,r,Math.pow(2,8*r),0);var o=1,i=0;for(this[t]=255&e;++i<r&&(o*=256);)this[t+i]=e/o&255;return t+r},i.prototype.writeUIntBE=function(e,t,r,n){e=+e,t=0|t,r=0|r,n||x(this,e,t,r,Math.pow(2,8*r),0);var o=r-1,i=1;for(this[t+o]=255&e;--o>=0&&(i*=256);)this[t+o]=e/i&255;return t+r},i.prototype.writeUInt8=function(e,t,r){return e=+e,t=0|t,r||x(this,e,t,1,255,0),i.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},i.prototype.writeUInt16LE=function(e,t,r){return e=+e,t=0|t,r||x(this,e,t,2,65535,0),i.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):N(this,e,t,!0),t+2},i.prototype.writeUInt16BE=function(e,t,r){return e=+e,t=0|t,r||x(this,e,t,2,65535,0),i.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):N(this,e,t,!1),t+2},i.prototype.writeUInt32LE=function(e,t,r){return e=+e,t=0|t,r||x(this,e,t,4,4294967295,0),i.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):j(this,e,t,!0),t+4},i.prototype.writeUInt32BE=function(e,t,r){return e=+e,t=0|t,r||x(this,e,t,4,4294967295,0),i.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):j(this,e,t,!1),t+4},i.prototype.writeIntLE=function(e,t,r,n){if(e=+e,t=0|t,!n){var o=Math.pow(2,8*r-1);x(this,e,t,r,o-1,-o)}var i=0,s=1,a=0>e?1:0;for(this[t]=255&e;++i<r&&(s*=256);)this[t+i]=(e/s>>0)-a&255;return t+r},i.prototype.writeIntBE=function(e,t,r,n){if(e=+e,t=0|t,!n){var o=Math.pow(2,8*r-1);x(this,e,t,r,o-1,-o)}var i=r-1,s=1,a=0>e?1:0;for(this[t+i]=255&e;--i>=0&&(s*=256);)this[t+i]=(e/s>>0)-a&255;return t+r},i.prototype.writeInt8=function(e,t,r){return e=+e,t=0|t,r||x(this,e,t,1,127,-128),i.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),0>e&&(e=255+e+1),this[t]=255&e,t+1},i.prototype.writeInt16LE=function(e,t,r){return e=+e,t=0|t,r||x(this,e,t,2,32767,-32768),i.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):N(this,e,t,!0),t+2},i.prototype.writeInt16BE=function(e,t,r){return e=+e,t=0|t,r||x(this,e,t,2,32767,-32768),i.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):N(this,e,t,!1),t+2},i.prototype.writeInt32LE=function(e,t,r){return e=+e,t=0|t,r||x(this,e,t,4,2147483647,-2147483648),i.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):j(this,e,t,!0),t+4},i.prototype.writeInt32BE=function(e,t,r){return e=+e,t=0|t,r||x(this,e,t,4,2147483647,-2147483648),0>e&&(e=4294967295+e+1),i.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):j(this,e,t,!1),t+4},i.prototype.writeFloatLE=function(e,t,r){return k(this,e,t,!0,r)},i.prototype.writeFloatBE=function(e,t,r){return k(this,e,t,!1,r)},i.prototype.writeDoubleLE=function(e,t,r){return M(this,e,t,!0,r)},i.prototype.writeDoubleBE=function(e,t,r){return M(this,e,t,!1,r)},i.prototype.copy=function(e,t,r,n){if(r||(r=0),n||0===n||(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&r>n&&(n=r),n===r)return 0;if(0===e.length||0===this.length)return 0;if(0>t)throw new RangeError("targetStart out of bounds");if(0>r||r>=this.length)throw new RangeError("sourceStart out of bounds");if(0>n)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-r&&(n=e.length-t+r);var o,s=n-r;if(this===e&&t>r&&n>t)for(o=s-1;o>=0;o--)e[o+t]=this[o+r];else if(1e3>s||!i.TYPED_ARRAY_SUPPORT)for(o=0;s>o;o++)e[o+t]=this[o+r];else e._set(this.subarray(r,r+s),t);return s},i.prototype.fill=function(e,t,r){if(e||(e=0),t||(t=0),r||(r=this.length),t>r)throw new RangeError("end < start");if(r!==t&&0!==this.length){if(0>t||t>=this.length)throw new RangeError("start out of bounds");if(0>r||r>this.length)throw new RangeError("end out of bounds");var n;if("number"==typeof e)for(n=t;r>n;n++)this[n]=e;else{var o=V(e.toString()),i=o.length;for(n=t;r>n;n++)this[n]=o[n%i]}return this}},i.prototype.toArrayBuffer=function(){if("undefined"!=typeof Uint8Array){if(i.TYPED_ARRAY_SUPPORT)return new i(this).buffer;for(var e=new Uint8Array(this.length),t=0,r=e.length;r>t;t+=1)e[t]=this[t];return e.buffer}throw new TypeError("Buffer.toArrayBuffer not supported in this browser")};var Z=i.prototype;i._augment=function(e){return e.constructor=i,e._isBuffer=!0,e._set=e.set,e.get=Z.get,e.set=Z.set,e.write=Z.write,e.toString=Z.toString,e.toLocaleString=Z.toString,e.toJSON=Z.toJSON,e.equals=Z.equals,e.compare=Z.compare,e.indexOf=Z.indexOf,e.copy=Z.copy,e.slice=Z.slice,e.readUIntLE=Z.readUIntLE,e.readUIntBE=Z.readUIntBE,e.readUInt8=Z.readUInt8,e.readUInt16LE=Z.readUInt16LE,e.readUInt16BE=Z.readUInt16BE,e.readUInt32LE=Z.readUInt32LE,e.readUInt32BE=Z.readUInt32BE,e.readIntLE=Z.readIntLE,e.readIntBE=Z.readIntBE,e.readInt8=Z.readInt8,e.readInt16LE=Z.readInt16LE,e.readInt16BE=Z.readInt16BE,e.readInt32LE=Z.readInt32LE,e.readInt32BE=Z.readInt32BE,e.readFloatLE=Z.readFloatLE,e.readFloatBE=Z.readFloatBE,e.readDoubleLE=Z.readDoubleLE,e.readDoubleBE=Z.readDoubleBE,e.writeUInt8=Z.writeUInt8,e.writeUIntLE=Z.writeUIntLE,e.writeUIntBE=Z.writeUIntBE,e.writeUInt16LE=Z.writeUInt16LE,e.writeUInt16BE=Z.writeUInt16BE,e.writeUInt32LE=Z.writeUInt32LE,e.writeUInt32BE=Z.writeUInt32BE,e.writeIntLE=Z.writeIntLE,e.writeIntBE=Z.writeIntBE,e.writeInt8=Z.writeInt8,e.writeInt16LE=Z.writeInt16LE,e.writeInt16BE=Z.writeInt16BE,e.writeInt32LE=Z.writeInt32LE,e.writeInt32BE=Z.writeInt32BE,e.writeFloatLE=Z.writeFloatLE,e.writeFloatBE=Z.writeFloatBE,e.writeDoubleLE=Z.writeDoubleLE,e.writeDoubleBE=Z.writeDoubleBE,e.fill=Z.fill,e.inspect=Z.inspect,e.toArrayBuffer=Z.toArrayBuffer,e};var ee=/[^+\/0-9A-Za-z-_]/g}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"base64-js":1,ieee754:4,"is-array":5}],3:[function(e,t,r){function n(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function o(e){return"function"==typeof e}function i(e){return"number"==typeof e}function s(e){return"object"==typeof e&&null!==e}function a(e){return void 0===e}t.exports=n,n.EventEmitter=n,n.prototype._events=void 0,n.prototype._maxListeners=void 0,n.defaultMaxListeners=10,n.prototype.setMaxListeners=function(e){if(!i(e)||0>e||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},n.prototype.emit=function(e){var t,r,n,i,u,f;if(this._events||(this._events={}),"error"===e&&(!this._events.error||s(this._events.error)&&!this._events.error.length)){if(t=arguments[1],t instanceof Error)throw t;throw TypeError('Uncaught, unspecified "error" event.')}if(r=this._events[e],a(r))return!1;if(o(r))switch(arguments.length){case 1:r.call(this);break;case 2:r.call(this,arguments[1]);break;case 3:r.call(this,arguments[1],arguments[2]);break;default:i=Array.prototype.slice.call(arguments,1),r.apply(this,i)}else if(s(r))for(i=Array.prototype.slice.call(arguments,1),f=r.slice(),n=f.length,u=0;n>u;u++)f[u].apply(this,i);return!0},n.prototype.addListener=function(e,t){var r;if(!o(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,o(t.listener)?t.listener:t),this._events[e]?s(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,s(this._events[e])&&!this._events[e].warned&&(r=a(this._maxListeners)?n.defaultMaxListeners:this._maxListeners,r&&r>0&&this._events[e].length>r&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace())),this},n.prototype.on=n.prototype.addListener,n.prototype.once=function(e,t){function r(){this.removeListener(e,r),n||(n=!0,t.apply(this,arguments))}if(!o(t))throw TypeError("listener must be a function");var n=!1;return r.listener=t,this.on(e,r),this},n.prototype.removeListener=function(e,t){var r,n,i,a;if(!o(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(r=this._events[e],i=r.length,n=-1,r===t||o(r.listener)&&r.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(s(r)){for(a=i;a-->0;)if(r[a]===t||r[a].listener&&r[a].listener===t){n=a;break}if(0>n)return this;1===r.length?(r.length=0,delete this._events[e]):r.splice(n,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},n.prototype.removeAllListeners=function(e){var t,r;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(r=this._events[e],o(r))this.removeListener(e,r);else if(r)for(;r.length;)this.removeListener(e,r[r.length-1]);return delete this._events[e],this},n.prototype.listeners=function(e){var t;return t=this._events&&this._events[e]?o(this._events[e])?[this._events[e]]:this._events[e].slice():[]},n.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(o(t))return 1;if(t)return t.length}return 0},n.listenerCount=function(e,t){return e.listenerCount(t)}},{}],4:[function(e,t,r){r.read=function(e,t,r,n,o){var i,s,a=8*o-n-1,u=(1<<a)-1,f=u>>1,c=-7,h=r?o-1:0,l=r?-1:1,p=e[t+h];for(h+=l,i=p&(1<<-c)-1,p>>=-c,c+=a;c>0;i=256*i+e[t+h],h+=l,c-=8);for(s=i&(1<<-c)-1,i>>=-c,c+=n;c>0;s=256*s+e[t+h],h+=l,c-=8);if(0===i)i=1-f;else{if(i===u)return s?NaN:(p?-1:1)*(1/0);s+=Math.pow(2,n),i-=f}return(p?-1:1)*s*Math.pow(2,i-n)},r.write=function(e,t,r,n,o,i){var s,a,u,f=8*i-o-1,c=(1<<f)-1,h=c>>1,l=23===o?Math.pow(2,-24)-Math.pow(2,-77):0,p=n?0:i-1,d=n?1:-1,y=0>t||0===t&&0>1/t?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=c):(s=Math.floor(Math.log(t)/Math.LN2),t*(u=Math.pow(2,-s))<1&&(s--,u*=2),t+=s+h>=1?l/u:l*Math.pow(2,1-h),t*u>=2&&(s++,u/=2),s+h>=c?(a=0,s=c):s+h>=1?(a=(t*u-1)*Math.pow(2,o),s+=h):(a=t*Math.pow(2,h-1)*Math.pow(2,o),s=0));o>=8;e[r+p]=255&a,p+=d,a/=256,o-=8);for(s=s<<o|a,f+=o;f>0;e[r+p]=255&s,p+=d,s/=256,f-=8);e[r+p-d]|=128*y}},{}],5:[function(e,t,r){var n=Array.isArray,o=Object.prototype.toString;t.exports=n||function(e){return!!e&&"[object Array]"==o.call(e)}},{}],6:[function(e,t,r){function n(){c=!1,a.length?f=a.concat(f):h=-1,f.length&&o()}function o(){if(!c){var e=setTimeout(n);c=!0;for(var t=f.length;t;){for(a=f,f=[];++h<t;)a&&a[h].run();h=-1,t=f.length}a=null,c=!1,clearTimeout(e)}}function i(e,t){this.fun=e,this.array=t}function s(){}var a,u=t.exports={},f=[],c=!1,h=-1;u.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];f.push(new i(e,t)),1!==f.length||c||setTimeout(o,0)},i.prototype.run=function(){this.fun.apply(null,this.array)},u.title="browser",u.browser=!0,u.env={},u.argv=[],u.version="",u.versions={},u.on=s,u.addListener=s,u.once=s,u.off=s,u.removeListener=s,u.removeAllListeners=s,u.emit=s,u.binding=function(e){throw new Error("process.binding is not supported")},u.cwd=function(){return"/"},u.chdir=function(e){throw new Error("process.chdir is not supported")},u.umask=function(){return 0}},{}],7:[function(e,t,r){"use strict";function n(e){return e&&"object"==typeof e&&"default"in e?e["default"]:e}function o(){for(var e={},t=new p(function(t,r){e.resolve=t,e.reject=r}),r=new Array(arguments.length),n=0;n<r.length;n++)r[n]=arguments[n];return e.promise=t,p.resolve().then(function(){return fetch.apply(null,r)}).then(function(t){e.resolve(t)})["catch"](function(t){e.reject(t)}),e}function i(e,t){var r,n,i,s=new Headers,a={method:e.method,credentials:"include",headers:s};return e.json&&(s.set("Accept","application/json"),s.set("Content-Type",e.headers["Content-Type"]||"application/json")),e.body&&e.body instanceof Blob?l.readAsArrayBuffer(e.body,function(e){a.body=e}):e.body&&e.processData&&"string"!=typeof e.body?a.body=JSON.stringify(e.body):"body"in e?a.body=e.body:a.body=null,Object.keys(e.headers).forEach(function(t){e.headers.hasOwnProperty(t)&&s.set(t,e.headers[t])}),r=o(e.url,a),e.timeout>0&&(n=setTimeout(function(){r.reject(new Error("Load timeout for resource: "+e.url))},e.timeout)),r.promise.then(function(t){return i={statusCode:t.status},e.timeout>0&&clearTimeout(n),i.statusCode>=200&&i.statusCode<300?e.binary?t.blob():t.text():t.json()}).then(function(e){i.statusCode>=200&&i.statusCode<300?t(null,i,e):t(e,i)})["catch"](function(e){t(e,i)}),{abort:r.reject}}function s(e,t){var r,n,o=!1,i=function(){r.abort()},s=function(){o=!0,r.abort()};r=e.xhr?new e.xhr:new XMLHttpRequest;try{r.open(e.method,e.url)}catch(a){t(a,{statusCode:413})}r.withCredentials="withCredentials"in e?e.withCredentials:!0,"GET"===e.method?delete e.headers["Content-Type"]:e.json&&(e.headers.Accept="application/json",e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.body&&e.processData&&"string"!=typeof e.body&&(e.body=JSON.stringify(e.body))),e.binary&&(r.responseType="arraybuffer"),"body"in e||(e.body=null);for(var u in e.headers)e.headers.hasOwnProperty(u)&&r.setRequestHeader(u,e.headers[u]);return e.timeout>0&&(n=setTimeout(s,e.timeout),r.onprogress=function(){clearTimeout(n),4!==r.readyState&&(n=setTimeout(s,e.timeout))},"undefined"!=typeof r.upload&&(r.upload.onprogress=r.onprogress)),r.onreadystatechange=function(){if(4===r.readyState){var n={statusCode:r.status};if(r.status>=200&&r.status<300){var i;i=e.binary?l.blob([r.response||""],{type:r.getResponseHeader("Content-Type")}):r.responseText,t(null,n,i)}else{var s={};if(o)s=new Error("ETIMEDOUT"),n.statusCode=400;else try{s=JSON.parse(r.response)}catch(a){}t(s,n)}}},e.body&&e.body instanceof Blob?l.readAsArrayBuffer(e.body,function(e){r.send(e)}):r.send(e.body),{abort:i}}function a(){try{return new XMLHttpRequest,!0}catch(e){return!1}}function u(e,t){return v||e.xhr?s(e,t):i(e,t)}function f(){return""}function c(e,t){function r(t,r,n){if(!e.binary&&e.json&&"string"==typeof t)try{t=JSON.parse(t)}catch(o){return n(o)}Array.isArray(t)&&(t=t.map(function(e){return e.error||e.missing?y.generateErrorFromResponse(e):e})),e.binary&&g(t,r),n(null,t,r)}function n(e,t){var r,n;if(e.code&&e.status){var o=new Error(e.message||e.code);return o.status=e.status,t(o)}if(e.message&&"ETIMEDOUT"===e.message)return t(e);try{r=JSON.parse(e.responseText),n=y.generateErrorFromResponse(r)}catch(i){n=y.generateErrorFromResponse(e)}t(n)}e=l.clone(e);var o={method:"GET",headers:{},json:!0,processData:!0,timeout:1e4,cache:!1};return e=d.extend(o,e),e.json&&(e.binary||(e.headers.Accept="application/json"),e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json"),e.binary&&(e.encoding=null,e.json=!1),e.processData||(e.json=!1),u(e,function(o,i,s){if(o)return o.status=i?i.statusCode:400,n(o,t);var a,u=i.headers&&i.headers["content-type"],c=s||f();if(!e.binary&&(e.json||!e.processData)&&"object"!=typeof c&&(/json/.test(u)||/^[\s]*\{/.test(c)&&/\}[\s]*$/.test(c)))try{c=JSON.parse(c.toString())}catch(h){}i.statusCode>=200&&i.statusCode<300?r(c,i,t):(a=y.generateErrorFromResponse(c),a.status=i.statusCode,t(a))})}function h(e,t){var r=navigator&&navigator.userAgent?navigator.userAgent.toLowerCase():"",n=-1!==r.indexOf("safari")&&-1===r.indexOf("chrome"),o=-1!==r.indexOf("msie"),i=-1!==r.indexOf("edge"),s=n||(o||i)&&"GET"===e.method,a="cache"in e?e.cache:!0,u=/^blob:/.test(e.url);if(!u&&(s||!a)){var f=-1!==e.url.indexOf("?");e.url+=(f?"&":"?")+"_nonce="+Date.now()}return c(e,t)}var l=e("pouchdb-utils"),p=n(e("pouchdb-promise")),d=e("js-extend"),y=e("pouchdb-errors"),v=a(),g=function(){};t.exports=h},{"js-extend":8,"pouchdb-errors":9,"pouchdb-promise":10,"pouchdb-utils":11}],8:[function(e,t,r){(function(e){e("object"==typeof r?r:this)}).call(this,function(e){var t=Array.prototype.slice,r=Array.prototype.forEach,n=function(e){if("object"!=typeof e)throw e+" is not an object";var o=t.call(arguments,1);return r.call(o,function(t){if(t)for(var r in t)"object"==typeof t[r]&&e[r]?n.call(e,e[r],t[r]):e[r]=t[r]}),e};e.extend=n})},{}],9:[function(e,t,r){t.exports=e("/Users/nolan/workspace/pouchdb/packages/pouchdb-errors")},{"/Users/nolan/workspace/pouchdb/packages/pouchdb-errors":13}],10:[function(e,t,r){t.exports=e("/Users/nolan/workspace/pouchdb/packages/pouchdb-promise")},{"/Users/nolan/workspace/pouchdb/packages/pouchdb-promise":15}],11:[function(e,t,r){t.exports=e("/Users/nolan/workspace/pouchdb/packages/pouchdb-utils")},{"/Users/nolan/workspace/pouchdb/packages/pouchdb-utils":18}],12:[function(e,t,r){testUtils.ajax=e("./lib/index-browser")},{"./lib/index-browser":7}],13:[function(e,t,r){"use strict";function n(e){return e&&"object"==typeof e&&"default"in e?e["default"]:e}function o(e){Error.call(this,e.reason),this.status=e.status,this.name=e.error,this.message=e.reason,this.error=!0}function i(e,t,r){function n(t){for(var n in e)"function"!=typeof e[n]&&(this[n]=e[n]);void 0!==r&&(this.name=r),void 0!==t&&(this.reason=t)}return n.prototype=o.prototype,new n(t)}function s(e){var t,n,o,s,a;return n=e.error===!0&&"string"==typeof e.name?e.name:e.error,
  a=e.reason,o=U("name",n,a),e.missing||"missing"===a||"deleted"===a||"not_found"===n?o=r.MISSING_DOC:"doc_validation"===n?(o=r.DOC_VALIDATION,s=a):"bad_request"===n&&o.message!==a&&(o=r.BAD_REQUEST),o||(o=U("status",e.status,a)||y),t=i(o,a,n),s&&(t.message=s),e.id&&(t.id=e.id),e.status&&(t.status=e.status),e.missing&&(t.missing=e.missing),t}var a=n(e("inherits"));a(o,Error),o.prototype.toString=function(){return JSON.stringify({status:this.status,name:this.name,message:this.message,reason:this.reason})};var u=new o({status:401,error:"unauthorized",reason:"Name or password is incorrect."}),f=new o({status:400,error:"bad_request",reason:"Missing JSON list of 'docs'"});r.MISSING_DOC=new o({status:404,error:"not_found",reason:"missing"});var c=new o({status:409,error:"conflict",reason:"Document update conflict"}),h=new o({status:400,error:"invalid_id",reason:"_id field must contain a string"}),l=new o({status:412,error:"missing_id",reason:"_id is required for puts"}),p=new o({status:400,error:"bad_request",reason:"Only reserved document ids may start with underscore."}),d=new o({status:412,error:"precondition_failed",reason:"Database not open"}),y=new o({status:500,error:"unknown_error",reason:"Database encountered an unknown error"}),v=new o({status:500,error:"badarg",reason:"Some query argument is invalid"}),g=new o({status:400,error:"invalid_request",reason:"Request was invalid"}),m=new o({status:400,error:"query_parse_error",reason:"Some query parameter is invalid"});r.DOC_VALIDATION=new o({status:500,error:"doc_validation",reason:"Bad special document member"}),r.BAD_REQUEST=new o({status:400,error:"bad_request",reason:"Something wrong with the request"});var _=new o({status:400,error:"bad_request",reason:"Document must be a JSON object"}),b=new o({status:404,error:"not_found",reason:"Database not found"}),w=new o({status:500,error:"indexed_db_went_bad",reason:"unknown"}),E=new o({status:500,error:"web_sql_went_bad",reason:"unknown"}),A=new o({status:500,error:"levelDB_went_went_bad",reason:"unknown"}),I=new o({status:403,error:"forbidden",reason:"Forbidden by design doc validate_doc_update function"}),R=new o({status:400,error:"bad_request",reason:"Invalid rev format"}),B=new o({status:412,error:"file_exists",reason:"The database could not be created, the file already exists."}),S=new o({status:412,error:"missing_stub"}),L=new o({status:413,error:"invalid_url",reason:"Provided URL is invalid"}),T={UNAUTHORIZED:u,MISSING_BULK_DOCS:f,MISSING_DOC:r.MISSING_DOC,REV_CONFLICT:c,INVALID_ID:h,MISSING_ID:l,RESERVED_ID:p,NOT_OPEN:d,UNKNOWN_ERROR:y,BAD_ARG:v,INVALID_REQUEST:g,QUERY_PARSE_ERROR:m,DOC_VALIDATION:r.DOC_VALIDATION,BAD_REQUEST:r.BAD_REQUEST,NOT_AN_OBJECT:_,DB_MISSING:b,WSQ_ERROR:E,LDB_ERROR:A,FORBIDDEN:I,INVALID_REV:R,FILE_EXISTS:B,MISSING_STUB:S,IDB_ERROR:w,INVALID_URL:L},U=function(e,t,r){var n=Object.keys(T).filter(function(r){var n=T[r];return"function"!=typeof n&&n[e]===t}),o=r&&n.filter(function(e){var t=T[e];return t.message===r})[0]||n[0];return o?T[o]:null};r.UNAUTHORIZED=u,r.MISSING_BULK_DOCS=f,r.REV_CONFLICT=c,r.INVALID_ID=h,r.MISSING_ID=l,r.RESERVED_ID=p,r.NOT_OPEN=d,r.UNKNOWN_ERROR=y,r.BAD_ARG=v,r.INVALID_REQUEST=g,r.QUERY_PARSE_ERROR=m,r.NOT_AN_OBJECT=_,r.DB_MISSING=b,r.WSQ_ERROR=E,r.LDB_ERROR=A,r.FORBIDDEN=I,r.INVALID_REV=R,r.FILE_EXISTS=B,r.MISSING_STUB=S,r.IDB_ERROR=w,r.INVALID_URL=L,r.getErrorTypeByProp=U,r.createError=i,r.generateErrorFromResponse=s,r.errors=T},{inherits:14}],14:[function(e,t,r){"function"==typeof Object.create?t.exports=function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})}:t.exports=function(e,t){e.super_=t;var r=function(){};r.prototype=t.prototype,e.prototype=new r,e.prototype.constructor=e}},{}],15:[function(e,t,r){"use strict";function n(e){return e&&"object"==typeof e&&"default"in e?e["default"]:e}var o=n(e("lie")),i="function"==typeof Promise?Promise:o;t.exports=i},{lie:16}],16:[function(e,t,r){"use strict";function n(){}function o(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=m,this.queue=[],this.outcome=void 0,e!==n&&u(this,e)}function i(e,t,r){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof r&&(this.onRejected=r,this.callRejected=this.otherCallRejected)}function s(e,t,r){d(function(){var n;try{n=t(r)}catch(o){return y.reject(e,o)}n===e?y.reject(e,new TypeError("Cannot resolve promise with itself")):y.resolve(e,n)})}function a(e){var t=e&&e.then;return e&&"object"==typeof e&&"function"==typeof t?function(){t.apply(e,arguments)}:void 0}function u(e,t){function r(t){i||(i=!0,y.reject(e,t))}function n(t){i||(i=!0,y.resolve(e,t))}function o(){t(n,r)}var i=!1,s=f(o);"error"===s.status&&r(s.value)}function f(e,t){var r={};try{r.value=e(t),r.status="success"}catch(n){r.status="error",r.value=n}return r}function c(e){return e instanceof this?e:y.resolve(new this(n),e)}function h(e){var t=new this(n);return y.reject(t,e)}function l(e){function t(e,t){function n(e){s[t]=e,++a!==o||i||(i=!0,y.resolve(f,s))}r.resolve(e).then(n,function(e){i||(i=!0,y.reject(f,e))})}var r=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var o=e.length,i=!1;if(!o)return this.resolve([]);for(var s=new Array(o),a=0,u=-1,f=new this(n);++u<o;)t(e[u],u);return f}function p(e){function t(e){r.resolve(e).then(function(e){i||(i=!0,y.resolve(a,e))},function(e){i||(i=!0,y.reject(a,e))})}var r=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var o=e.length,i=!1;if(!o)return this.resolve([]);for(var s=-1,a=new this(n);++s<o;)t(e[s]);return a}var d=e("immediate"),y={},v=["REJECTED"],g=["FULFILLED"],m=["PENDING"];t.exports=o,o.prototype["catch"]=function(e){return this.then(null,e)},o.prototype.then=function(e,t){if("function"!=typeof e&&this.state===g||"function"!=typeof t&&this.state===v)return this;var r=new this.constructor(n);if(this.state!==m){var o=this.state===g?e:t;s(r,o,this.outcome)}else this.queue.push(new i(r,e,t));return r},i.prototype.callFulfilled=function(e){y.resolve(this.promise,e)},i.prototype.otherCallFulfilled=function(e){s(this.promise,this.onFulfilled,e)},i.prototype.callRejected=function(e){y.reject(this.promise,e)},i.prototype.otherCallRejected=function(e){s(this.promise,this.onRejected,e)},y.resolve=function(e,t){var r=f(a,t);if("error"===r.status)return y.reject(e,r.value);var n=r.value;if(n)u(e,n);else{e.state=g,e.outcome=t;for(var o=-1,i=e.queue.length;++o<i;)e.queue[o].callFulfilled(t)}return e},y.reject=function(e,t){e.state=v,e.outcome=t;for(var r=-1,n=e.queue.length;++r<n;)e.queue[r].callRejected(t);return e},o.resolve=c,o.reject=h,o.all=l,o.race=p},{immediate:17}],17:[function(e,t,r){(function(e){"use strict";function r(){c=!0;for(var e,t,r=h.length;r;){for(t=h,h=[],e=-1;++e<r;)t[e]();r=h.length}c=!1}function n(e){1!==h.push(e)||c||o()}var o,i=e.MutationObserver||e.WebKitMutationObserver;if(i){var s=0,a=new i(r),u=e.document.createTextNode("");a.observe(u,{characterData:!0}),o=function(){u.data=s=++s%2}}else if(e.setImmediate||"undefined"==typeof e.MessageChannel)o="document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var t=e.document.createElement("script");t.onreadystatechange=function(){r(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null},e.document.documentElement.appendChild(t)}:function(){setTimeout(r,0)};else{var f=new e.MessageChannel;f.port1.onmessage=r,o=function(){f.port2.postMessage(0)}}var c,h=[];t.exports=n}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],18:[function(e,t,r){(function(t,n,o){"use strict";function i(e){return e&&"object"==typeof e&&"default"in e?e["default"]:e}function s(e){return e instanceof ArrayBuffer||"undefined"!=typeof Blob&&e instanceof Blob}function a(e){if("function"==typeof e.slice)return e.slice(0);var t=new ArrayBuffer(e.byteLength),r=new Uint8Array(t),n=new Uint8Array(e);return r.set(n),t}function u(e){if(e instanceof ArrayBuffer)return a(e);var t=e.size,r=e.type;return"function"==typeof e.slice?e.slice(0,t,r):e.webkitSlice(0,t,r)}function f(e){var t,r,n;if(!e||"object"!=typeof e)return e;if(Array.isArray(e)){for(t=[],r=0,n=e.length;n>r;r++)t[r]=f(e[r]);return t}if(e instanceof Date)return e.toISOString();if(s(e))return u(e);t={};for(r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var o=f(e[r]);"undefined"!=typeof o&&(t[r]=o)}return t}function c(e){var t=!1;return Ce(function(r){if(t)throw new Error("once called more than once");t=!0,e.apply(this,r)})}function h(e){return Ce(function(r){r=f(r);var n,o=this,i="function"==typeof r[r.length-1]?r.pop():!1;i&&(n=function(e,r){t.nextTick(function(){i(e,r)})});var s=new Oe(function(t,n){var i;try{var s=c(function(e,r){e?n(e):t(r)});r.push(s),i=e.apply(o,r),i&&"function"==typeof i.then&&t(i)}catch(a){n(a)}});return n&&s.then(function(e){n(null,e)},n),s})}function l(e,t){function r(e,t,r){if(Fe.enabled){for(var n=[e._db_name,t],o=0;o<r.length-1;o++)n.push(r[o]);Fe.apply(null,n);var i=r[r.length-1];r[r.length-1]=function(r,n){var o=[e._db_name,t];o=o.concat(r?["error",r]:["success",n]),Fe.apply(null,o),i(r,n)}}}return h(Ce(function(n){if(this._closed)return Oe.reject(new Error("database is closed"));if(this._destroyed)return Oe.reject(new Error("database is destroyed"));var o=this;return r(o,e,n),this.taskqueue.isReady?t.apply(this,n):new Oe(function(t,r){o.taskqueue.addTask(function(i){i?r(i):t(o[e].apply(o,n))})})}))}function p(e,t){for(var r={},n=0,o=t.length;o>n;n++){var i=t[n];i in e&&(r[i]=e[i])}return r}function d(e,t,r){function n(){var e=[];c.forEach(function(t){t.docs.forEach(function(r){e.push({id:t.id,docs:[r]})})}),r(null,{results:e})}function o(){++f===u&&n()}function i(e,t,r){c[e]={id:t,docs:r},o()}var s=Array.isArray(t)?t:t.docs,a={};s.forEach(function(e){e.id in a?a[e.id].push(e):a[e.id]=[e]});var u=Object.keys(a).length,f=0,c=new Array(u);Object.keys(a).forEach(function(r,n){var o=a[r],s=p(o[0],["atts_since","attachments"]);s.open_revs=o.map(function(e){return e.rev}),s.open_revs=s.open_revs.filter(function(e){return e});var u=function(e){return e};0===s.open_revs.length&&(delete s.open_revs,u=function(e){return[{ok:e}]}),["revs","attachments","binary","ajax"].forEach(function(e){e in t&&(s[e]=t[e])}),e.get(r,s,function(e,t){i(n,r,e?[{error:e}]:u(t))})})}function y(e,t){"console"in n&&"info"in console&&console.info("The above "+e+" is totally normal. "+t)}function v(e){for(var t,r,n,o,i=e.rev_tree.slice();o=i.pop();){var s=o.ids,a=s[2],u=o.pos;if(a.length)for(var f=0,c=a.length;c>f;f++)i.push({pos:u+1,ids:a[f]});else{var h=!!s[1].deleted,l=s[0];(!t||(n!==h?n:r!==u?u>r:l>t))&&(t=l,r=u,n=h)}}return r+"-"+t}function g(e){return e.ids}function m(e,t){t||(t=v(e));for(var r,n=t.substring(t.indexOf("-")+1),o=e.rev_tree.map(g);r=o.pop();){if(r[0]===n)return!!r[1].deleted;o=o.concat(r[2])}}function _(e){return/^_local/.test(e)}function b(e){if(!e)return null;var t=e.split("/");return 2===t.length?t:1===t.length?[e,e]:null}function w(e){var t=b(e);return t?t.join("/"):null}function E(e){return 0|Math.random()*e}function A(e,t){t=t||Ye.length;var r="",n=-1;if(e){for(;++n<e;)r+=Ye[E(t)];return r}for(;++n<36;)switch(n){case 8:case 13:case 18:case 23:r+="-";break;case 19:r+=Ye[3&E(16)|8];break;default:r+=Ye[E(16)]}return r}function I(e){return e.reduce(function(e,t){return e[t]=!0,e},{})}function R(e){var t;if(e?"string"!=typeof e?t=xe.createError(xe.INVALID_ID):/^_/.test(e)&&!/^_(design|local)/.test(e)&&(t=xe.createError(xe.RESERVED_ID)):t=xe.createError(xe.MISSING_ID),t)throw t}function B(e){if(!/^\d+\-./.test(e))return xe.createError(xe.INVALID_REV);var t=e.indexOf("-"),r=e.substring(0,t),n=e.substring(t+1);return{prefix:parseInt(r,10),id:n}}function S(e,t){for(var r=e.start-e.ids.length+1,n=e.ids,o=[n[0],t,[]],i=1,s=n.length;s>i;i++)o=[n[i],{status:"missing"},[o]];return[{pos:r,ids:o}]}function L(e,t){var r,n,o,i={status:"available"};if(e._deleted&&(i.deleted=!0),t)if(e._id||(e._id=A()),n=A(32,16).toLowerCase(),e._rev){if(o=B(e._rev),o.error)return o;e._rev_tree=[{pos:o.prefix,ids:[o.id,{status:"missing"},[[n,i,[]]]]}],r=o.prefix+1}else e._rev_tree=[{pos:1,ids:[n,i,[]]}],r=1;else if(e._revisions&&(e._rev_tree=S(e._revisions,i),r=e._revisions.start,n=e._revisions.ids[0]),!e._rev_tree){if(o=B(e._rev),o.error)return o;r=o.prefix,n=o.id,e._rev_tree=[{pos:r,ids:[n,i,[]]}]}R(e._id),e._rev=r+"-"+n;var s={metadata:{},data:{}};for(var a in e)if(Object.prototype.hasOwnProperty.call(e,a)){var u="_"===a[0];if(u&&!qe[a]){var f=xe.createError(xe.DOC_VALIDATION,a);throw f.message=xe.DOC_VALIDATION.message+": "+a,f}u&&!Ve[a]?s.metadata[a.slice(1)]=e[a]:s.data[a]=e[a]}return s}function T(e){for(var t="",r=new Uint8Array(e),n=r.byteLength,o=0;n>o;o++)t+=String.fromCharCode(r[o]);return t}function U(e,t){if("undefined"==typeof FileReader)return t((new FileReaderSync).readAsArrayBuffer(e));var r=new FileReader;r.onloadend=function(e){var r=e.target.result||new ArrayBuffer(0);t(r)},r.readAsArrayBuffer(e)}function O(e,t){e=e||[],t=t||{};try{return new Blob(e,t)}catch(r){if("TypeError"!==r.name)throw r;for(var n="undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder,o=new n,i=0;i<e.length;i+=1)o.append(e[i]);return o.getBlob(t.type)}}function C(e){for(var t=e.length,r=new ArrayBuffer(t),n=new Uint8Array(r),o=0;t>o;o++)n[o]=e.charCodeAt(o);return r}function D(e,t){return O([C(e)],{type:t})}function x(e){return Je(T(e))}function N(e){return Je(e)}function j(e,t,r,n){(r>0||n<t.byteLength)&&(t=new Uint8Array(t,r,Math.min(n,t.byteLength)-r)),e.append(t)}function P(e,t,r,n){(r>0||n<t.length)&&(t=t.substring(r,n)),e.appendBinary(t)}function k(e,t,r){function n(e){try{return Ge(e)}catch(t){var r=xe.createError(xe.BAD_ARG,"Attachment is not a valid base64 string");return{error:r}}}function o(e,r){if(e.stub)return r();if("string"==typeof e.data){var o=n(e.data);if(o.error)return r(o.error);e.length=o.length,"blob"===t?e.data=D(o,e.content_type):"base64"===t?e.data=Je(o):e.data=o,He(o).then(function(t){e.digest="md5-"+t,r()})}else U(e.data,function(n){"binary"===t?e.data=T(n):"base64"===t&&(e.data=x(n)),He(n).then(function(t){e.digest="md5-"+t,e.length=n.byteLength,r()})})}function i(){a++,e.length===a&&(s?r(s):r())}if(!e.length)return r();var s,a=0;e.forEach(function(e){function t(e){s=e,n++,n===r.length&&i()}var r=e.data&&e.data._attachments?Object.keys(e.data._attachments):[],n=0;if(!r.length)return i();for(var a in e.data._attachments)e.data._attachments.hasOwnProperty(a)&&o(e.data._attachments[a],t)})}function M(e){for(var t,r=[],n=e.slice();t=n.pop();){var o=t.pos,i=t.ids,s=i[0],a=i[1],u=i[2],f=0===u.length,c=t.history?t.history.slice():[];c.push({id:s,opts:a}),f&&r.push({pos:o+1-c.length,ids:c});for(var h=0,l=u.length;l>h;h++)n.push({pos:o+1,ids:u[h],history:c})}return r.reverse()}function F(e,t){for(var r,n=e.slice();r=n.pop();)for(var o=r.pos,i=r.ids,s=i[2],a=t(0===s.length,o,i[0],r.ctx,i[1]),u=0,f=s.length;f>u;u++)n.push({pos:o+1,ids:s[u],ctx:a})}function Y(e,t){return e.pos-t.pos}function q(e,t,r){for(var n,o=0,i=e.length;i>o;)n=o+i>>>1,r(e[n],t)<0?o=n+1:i=n;return o}function V(e,t,r){var n=q(e,t,r);e.splice(n,0,t)}function G(e,t){for(var r,n,o=t,i=e.length;i>o;o++){var s=e[o],a=[s.id,s.opts,[]];n?(n[2].push(a),n=a):r=n=a}return r}function J(e,t){return e[0]<t[0]?-1:1}function z(e,t){for(var r=[{tree1:e,tree2:t}],n=!1;r.length>0;){var o=r.pop(),i=o.tree1,s=o.tree2;(i[1].status||s[1].status)&&(i[1].status="available"===i[1].status||"available"===s[1].status?"available":"missing");for(var a=0;a<s[2].length;a++)if(i[2][0]){for(var u=!1,f=0;f<i[2].length;f++)i[2][f][0]===s[2][a][0]&&(r.push({tree1:i[2][f],tree2:s[2][a]}),u=!0);u||(n="new_branch",V(i[2],s[2][a],J))}else n="new_leaf",i[2][0]=s[2][a]}return{conflicts:n,tree:e}}function Q(e,t,r){var n,o=[],i=!1,s=!1;if(!e.length)return{tree:[t],conflicts:"new_leaf"};for(var a=0,u=e.length;u>a;a++){var f=e[a];if(f.pos===t.pos&&f.ids[0]===t.ids[0])n=z(f.ids,t.ids),o.push({pos:f.pos,ids:n.tree}),i=i||n.conflicts,s=!0;else if(r!==!0){var c=f.pos<t.pos?f:t,h=f.pos<t.pos?t:f,l=h.pos-c.pos,p=[],d=[];for(d.push({ids:c.ids,diff:l,parent:null,parentIdx:null});d.length>0;){var y=d.pop();if(0!==y.diff)for(var v=y.ids[2],g=0,m=v.length;m>g;g++)d.push({ids:v[g],diff:y.diff-1,parent:y.ids,parentIdx:g});else y.ids[0]===h.ids[0]&&p.push(y)}var _=p[0];_?(n=z(_.ids,h.ids),_.parent[2][_.parentIdx]=n.tree,o.push({pos:c.pos,ids:c.ids}),i=i||n.conflicts,s=!0):o.push(f)}else o.push(f)}return s||o.push(t),o.sort(Y),{tree:o,conflicts:i||"internal_node"}}function H(e,t){for(var r,n=M(e),o={},i=0,s=n.length;s>i;i++){for(var a=n[i],u=a.ids,f=Math.max(0,u.length-t),c={pos:a.pos+f,ids:G(u,f)},h=0;f>h;h++){var l=a.pos+h+"-"+u[h].id;o[l]=!0}r=r?Q(r,c,!0).tree:[c]}return F(r,function(e,t,r){delete o[t+"-"+r]}),{tree:r,revs:Object.keys(o)}}function W(e,t,r){var n=Q(e,t),o=H(n.tree,r);return{tree:o.tree,stemmedRevs:o.revs,conflicts:n.conflicts}}function $(e,t){for(var r,n=e.slice(),o=t.split("-"),i=parseInt(o[0],10),s=o[1];r=n.pop();){if(r.pos===i&&r.ids[0]===s)return!0;for(var a=r.ids[2],u=0,f=a.length;f>u;u++)n.push({pos:r.pos+1,ids:a[u]})}return!1}function K(e,t,r,n,o,i,s,a){if($(t.rev_tree,r.metadata.rev))return n[o]=r,i();var u=t.winningRev||v(t),f="deleted"in t?t.deleted:m(t,u),c="deleted"in r.metadata?r.metadata.deleted:m(r.metadata),h=/^1-/.test(r.metadata.rev);if(f&&!c&&a&&h){var l=r.data;l._rev=u,l._id=r.metadata.id,r=L(l,a)}var p=W(t.rev_tree,r.metadata.rev_tree[0],e),d=a&&(f&&c||!f&&"new_leaf"!==p.conflicts||f&&!c&&"new_branch"===p.conflicts);if(d){var y=xe.createError(xe.REV_CONFLICT);return n[o]=y,i()}var g=r.metadata.rev;r.metadata.rev_tree=p.tree,r.stemmedRevs=p.stemmedRevs||[],t.rev_map&&(r.metadata.rev_map=t.rev_map);var _,b=v(r.metadata),w=m(r.metadata,b),E=f===w?0:w>f?-1:1;_=g===b?w:m(r.metadata,g),s(r,b,w,_,!0,E,o,i)}function X(e){return"missing"===e.metadata.rev_tree[0].ids[1].status}function Z(e,t,r,n,o,i,s,a,u){function f(e,t,r){var n=v(e.metadata),o=m(e.metadata,n);if("was_delete"in a&&o)return i[t]=xe.createError(xe.MISSING_DOC,"deleted"),r();var u=h&&X(e);if(u){var f=xe.createError(xe.REV_CONFLICT);return i[t]=f,r()}var c=o?0:1;s(e,n,o,o,!1,c,t,r)}function c(){++p===d&&u&&u()}e=e||1e3;var h=a.new_edits,l=new je.Map,p=0,d=t.length;t.forEach(function(e,t){if(e._id&&_(e._id)){var n=e._deleted?"_removeLocal":"_putLocal";return void r[n](e,{ctx:o},function(e,r){i[t]=e||r,c()})}var s=e.metadata.id;l.has(s)?(d--,l.get(s).push([e,t])):l.set(s,[[e,t]])}),l.forEach(function(t,r){function o(){++u<t.length?a():c()}function a(){var a=t[u],c=a[0],l=a[1];if(n.has(r))K(e,n.get(r),c,i,l,o,s,h);else{var p=W([],c.metadata.rev_tree[0],e);c.metadata.rev_tree=p.tree,c.stemmedRevs=p.stemmedRevs||[],f(c,l,o)}}var u=0;a()})}function ee(){return"undefined"!=typeof chrome&&"undefined"!=typeof chrome.storage&&"undefined"!=typeof chrome.storage.local}function te(){return Ue}function re(e,t){for(var r in t)if(t.hasOwnProperty(r)){var n=f(t[r]);"undefined"!=typeof n&&(e[r]=n)}}function ne(e,t,r){return re(e,t),r&&re(e,r),e}function oe(e,t,r){try{return!e(t,r)}catch(n){var o="Filter function threw: "+n.toString();return xe.createError(xe.BAD_REQUEST,o)}}function ie(e){var t={},r=e.filter&&"function"==typeof e.filter;return t.query=e.query_params,function(n){n.doc||(n.doc={});var o=r&&oe(e.filter,n.doc,t);if("object"==typeof o)return o;if(o)return!1;if(e.include_docs){if(!e.attachments)for(var i in n.doc._attachments)n.doc._attachments.hasOwnProperty(i)&&(n.doc._attachments[i].stub=!0)}else delete n.doc;return!0}}function se(e){for(var t=[],r=0,n=e.length;n>r;r++)t=t.concat(e[r]);return t}function ae(){}function ue(){return"undefined"!=typeof cordova||"undefined"!=typeof PhoneGap||"undefined"!=typeof phonegap}function fe(e,t){return e.pos-t.pos}function ce(e){var t=[];F(e,function(e,r,n,o,i){e&&t.push({rev:r+"-"+n,pos:r,opts:i})}),t.sort(fe).reverse();for(var r=0,n=t.length;n>r;r++)delete t[r].pos;return t}function he(e){for(var t=v(e),r=ce(e.rev_tree),n=[],o=0,i=r.length;i>o;o++){var s=r[o];s.rev===t||s.opts.deleted||n.push(s.rev)}return n}function le(e){var t=[];return F(e.rev_tree,function(e,r,n,o,i){"available"!==i.status||e||(t.push(r+"-"+n),i.status="missing")}),t}function pe(e){return decodeURIComponent(window.escape(e))}function de(e){return 65>e?e-48:e-55}function ye(e,t,r){for(var n="";r>t;)n+=String.fromCharCode(de(e.charCodeAt(t++))<<4|de(e.charCodeAt(t++)));return n}function ve(e,t,r){for(var n="";r>t;)n+=String.fromCharCode(de(e.charCodeAt(t+2))<<12|de(e.charCodeAt(t+3))<<8|de(e.charCodeAt(t))<<4|de(e.charCodeAt(t+1))),t+=4;return n}function ge(e,t){return"UTF-8"===t?pe(ye(e,0,e.length)):ve(e,0,e.length)}function me(e){for(var t=rt.exec(e),r={},n=14;n--;){var o=Ze[n],i=t[n]||"",s=-1!==["user","password"].indexOf(o);r[o]=s?decodeURIComponent(i):i}return r[et]={},r[Ze[12]].replace(tt,function(e,t,n){t&&(r[et][t]=n)}),r}function _e(e){try{return JSON.parse(e)}catch(t){return Pe.parse(e)}}function be(e){return e.length<5e4?JSON.parse(e):_e(e)}function we(e){try{return JSON.stringify(e)}catch(t){return Pe.stringify(e)}}function Ee(e,t,r){return new Oe(function(n,o){e.get(t,function(i,s){if(i){if(404!==i.status)return o(i);s={}}var a=s._rev,u=r(s);return u?(u._id=t,u._rev=a,void n(Ae(e,u,r))):n({updated:!1,rev:a})})})}function Ae(e,t,r){return e.put(t).then(function(e){return{updated:!0,rev:e.rev}},function(n){if(409!==n.status)throw n;return Ee(e,t._id,r)})}function Ie(e,t){return D(Ge(e),t)}function Re(e,t){if("undefined"==typeof FileReader)return t(T((new FileReaderSync).readAsArrayBuffer(e)));var r=new FileReader,n="function"==typeof r.readAsBinaryString;r.onloadend=function(e){var r=e.target.result||"";return n?t(r):void t(T(r))},n?r.readAsBinaryString(e):r.readAsArrayBuffer(e)}function Be(e){return new Oe(function(t){Re(e,function(e){t(Je(e))})})}function Se(e,t,r){var n=new o(e,t);return n.type=r,n}function Le(e){ee()?chrome.storage.onChanged.addListener(function(t){null!=t.db_name&&e.emit(t.dbName.newValue)}):te()&&("undefined"!=typeof addEventListener?addEventListener("storage",function(t){e.emit(t.key)}):window.attachEvent("storage",function(t){e.emit(t.key)}))}function Te(){ke.EventEmitter.call(this),this._listeners={},Le(this)}var Ue,Oe=i(e("pouchdb-promise")),Ce=i(e("argsarray")),De=i(e("debug")),xe=e("pouchdb-errors"),Ne=i(e("spark-md5")),je=e("pouchdb-collections"),Pe=i(e("vuvuzela")),ke=e("events"),Me=i(e("inherits")),Fe=De("pouchdb:api"),Ye="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),qe=I(["_id","_rev","_attachments","_deleted","_revisions","_revs_info","_conflicts","_deleted_conflicts","_local_seq","_rev_tree","_replication_id","_replication_state","_replication_state_time","_replication_state_reason","_replication_stats","_removed"]),Ve=I(["_attachments","_replication_id","_replication_state","_replication_state_time","_replication_state_reason","_replication_stats"]),Ge=function(e){return atob(e)},Je=function(e){return btoa(e)},ze=n.setImmediate||n.setTimeout,Qe=32768,He=h(function(e,t){function r(){var n=a*i,o=n+i;if(a++,s>a)f(u,e,n,o),ze(r);else{f(u,e,n,o);var c=u.end(!0),h=N(c);t(null,h),u.destroy()}}var n="string"==typeof e,o=n?e.length:e.byteLength,i=Math.min(Qe,o),s=Math.ceil(o/i),a=0,u=n?new Ne:new Ne.ArrayBuffer,f=n?P:j;r()});if(ee())Ue=!1;else try{localStorage.setItem("_pouch_check_localstorage",1),Ue=!!localStorage.getItem("_pouch_check_localstorage")}catch(We){Ue=!1}var $e,Ke=ae.name;$e=Ke?function(e){return e.name}:function(e){return e.toString().match(/^\s*function\s*(\S*)\s*\(/)[1]};var Xe=$e,Ze=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],et="queryKey",tt=/(?:^|&)([^&=]*)=?([^&]*)/g,rt=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/;Me(Te,ke.EventEmitter),Te.prototype.addListener=function(e,t,r,n){function o(){function e(){s=!1}if(i._listeners[t]){if(s)return void(s="waiting");s=!0;var a=p(n,["style","include_docs","attachments","conflicts","filter","doc_ids","view","since","query_params","binary"]);r.changes(a).on("change",function(e){e.seq>n.since&&!n.cancelled&&(n.since=e.seq,n.onChange(e))}).on("complete",function(){"waiting"===s&&setTimeout(function(){o()},0),s=!1}).on("error",e)}}if(!this._listeners[t]){var i=this,s=!1;this._listeners[t]=o,this.on(e,o)}},Te.prototype.removeListener=function(e,t){t in this._listeners&&ke.EventEmitter.prototype.removeListener.call(this,e,this._listeners[t])},Te.prototype.notifyLocalWindows=function(e){ee()?chrome.storage.local.set({dbName:e}):te()&&(localStorage[e]="a"===localStorage[e]?"b":"a")},Te.prototype.notify=function(e){this.emit(e),this.notifyLocalWindows(e)},r.adapterFun=l,r.bulkGetShim=d,r.clone=f,r.explainError=y,r.isDeleted=m,r.isLocalId=_,r.normalizeDdocFunctionName=w,r.parseDdocFunctionName=b,r.parseDoc=L,r.invalidIdError=R,r.preprocessAttachments=k,r.processDocs=Z,r.updateDoc=K,r.hasLocalStorage=te,r.isChromeApp=ee,r.extend=ne,r.filterChange=ie,r.flatten=se,r.functionName=Xe,r.merge=W,r.isCordova=ue,r.md5=He,r.collectConflicts=he,r.collectLeaves=ce,r.compactTree=le,r.revExists=$,r.rootToLeaf=M,r.traverseRevTree=F,r.winningRev=v,r.once=c,r.parseHexString=ge,r.parseUri=me,r.pick=p,r.safeJsonParse=be,r.safeJsonStringify=we,r.toPromise=h,r.upsert=Ee,r.uuid=A,r.arrayBufferToBase64=x,r.arrayBufferToBinaryString=T,r.atob=Ge,r.btoa=Je,r.base64StringToBlobOrBuffer=Ie,r.binaryStringToArrayBuffer=C,r.binaryStringToBlobOrBuffer=D,r.blob=O,r.blobOrBufferToBase64=Be,r.readAsArrayBuffer=U,r.readAsBinaryString=Re,r.typedBuffer=Se,r.changesHandler=Te}).call(this,e("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},e("buffer").Buffer)},{_process:6,argsarray:19,buffer:2,debug:20,events:3,inherits:23,"pouchdb-collections":24,"pouchdb-errors":25,"pouchdb-promise":26,"spark-md5":27,vuvuzela:28}],19:[function(e,t,r){"use strict";function n(e){return function(){var t=arguments.length;if(t){for(var r=[],n=-1;++n<t;)r[n]=arguments[n];return e.call(this,r)}return e.call(this,[])}}t.exports=n},{}],20:[function(e,t,r){function n(){return"WebkitAppearance"in document.documentElement.style||window.console&&(console.firebug||console.exception&&console.table)||navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31}function o(){var e=arguments,t=this.useColors;if(e[0]=(t?"%c":"")+this.namespace+(t?" %c":" ")+e[0]+(t?"%c ":" ")+"+"+r.humanize(this.diff),!t)return e;var n="color: "+this.color;e=[e[0],n,"color: inherit"].concat(Array.prototype.slice.call(e,1));var o=0,i=0;return e[0].replace(/%[a-z%]/g,function(e){"%%"!==e&&(o++,"%c"===e&&(i=o))}),e.splice(i,0,n),e}function i(){return"object"==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)}function s(e){try{null==e?r.storage.removeItem("debug"):r.storage.debug=e}catch(t){}}function a(){var e;try{e=r.storage.debug}catch(t){}return e}function u(){try{return window.localStorage}catch(e){}}r=t.exports=e("./debug"),r.log=i,r.formatArgs=o,r.save=s,r.load=a,r.useColors=n,r.storage="undefined"!=typeof chrome&&"undefined"!=typeof chrome.storage?chrome.storage.local:u(),r.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"],r.formatters.j=function(e){return JSON.stringify(e)},r.enable(a())},{"./debug":21}],21:[function(e,t,r){function n(){return r.colors[c++%r.colors.length]}function o(e){function t(){}function o(){var e=o,t=+new Date,i=t-(f||t);e.diff=i,e.prev=f,e.curr=t,f=t,null==e.useColors&&(e.useColors=r.useColors()),null==e.color&&e.useColors&&(e.color=n());var s=Array.prototype.slice.call(arguments);s[0]=r.coerce(s[0]),"string"!=typeof s[0]&&(s=["%o"].concat(s));var a=0;s[0]=s[0].replace(/%([a-z%])/g,function(t,n){if("%%"===t)return t;a++;var o=r.formatters[n];if("function"==typeof o){var i=s[a];t=o.call(e,i),s.splice(a,1),a--}return t}),"function"==typeof r.formatArgs&&(s=r.formatArgs.apply(e,s));var u=o.log||r.log||console.log.bind(console);u.apply(e,s)}t.enabled=!1,o.enabled=!0;var i=r.enabled(e)?o:t;return i.namespace=e,i}function i(e){r.save(e);for(var t=(e||"").split(/[\s,]+/),n=t.length,o=0;n>o;o++)t[o]&&(e=t[o].replace(/\*/g,".*?"),"-"===e[0]?r.skips.push(new RegExp("^"+e.substr(1)+"$")):r.names.push(new RegExp("^"+e+"$")))}function s(){r.enable("")}function a(e){var t,n;for(t=0,n=r.skips.length;n>t;t++)if(r.skips[t].test(e))return!1;for(t=0,n=r.names.length;n>t;t++)if(r.names[t].test(e))return!0;return!1}function u(e){return e instanceof Error?e.stack||e.message:e}r=t.exports=o,r.coerce=u,r.disable=s,r.enable=i,r.enabled=a,r.humanize=e("ms"),r.names=[],r.skips=[],r.formatters={};var f,c=0},{ms:22}],22:[function(e,t,r){function n(e){if(e=""+e,!(e.length>1e4)){var t=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(e);if(t){var r=parseFloat(t[1]),n=(t[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return r*h;case"days":case"day":case"d":return r*c;case"hours":case"hour":case"hrs":case"hr":case"h":return r*f;case"minutes":case"minute":case"mins":case"min":case"m":return r*u;case"seconds":case"second":case"secs":case"sec":case"s":return r*a;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return r}}}}function o(e){return e>=c?Math.round(e/c)+"d":e>=f?Math.round(e/f)+"h":e>=u?Math.round(e/u)+"m":e>=a?Math.round(e/a)+"s":e+"ms"}function i(e){return s(e,c,"day")||s(e,f,"hour")||s(e,u,"minute")||s(e,a,"second")||e+" ms"}function s(e,t,r){return t>e?void 0:1.5*t>e?Math.floor(e/t)+" "+r:Math.ceil(e/t)+" "+r+"s"}var a=1e3,u=60*a,f=60*u,c=24*f,h=365.25*c;t.exports=function(e,t){return t=t||{},"string"==typeof e?n(e):t["long"]?i(e):o(e)}},{}],23:[function(e,t,r){arguments[4][14][0].apply(r,arguments)},{dup:14}],24:[function(e,t,r){"use strict";function n(){this.store={}}function o(e){if(this.store=new n,e&&Array.isArray(e))for(var t=0,r=e.length;r>t;t++)this.add(e[t])}r.Map=n,r.Set=o,n.prototype.mangle=function(e){if("string"!=typeof e)throw new TypeError("key must be a string but Got "+e);return"$"+e},n.prototype.unmangle=function(e){return e.substring(1)},n.prototype.get=function(e){var t=this.mangle(e);return t in this.store?this.store[t]:void 0},n.prototype.set=function(e,t){var r=this.mangle(e);return this.store[r]=t,!0},n.prototype.has=function(e){var t=this.mangle(e);return t in this.store},n.prototype["delete"]=function(e){var t=this.mangle(e);return t in this.store?(delete this.store[t],!0):!1},n.prototype.forEach=function(e){for(var t=Object.keys(this.store),r=0,n=t.length;n>r;r++){var o=t[r],i=this.store[o];o=this.unmangle(o),e(i,o)}},o.prototype.add=function(e){return this.store.set(e,!0)},o.prototype.has=function(e){return this.store.has(e)},o.prototype["delete"]=function(e){return this.store["delete"](e)}},{}],25:[function(e,t,r){arguments[4][9][0].apply(r,arguments)},{"/Users/nolan/workspace/pouchdb/packages/pouchdb-errors":13,dup:9}],26:[function(e,t,r){arguments[4][10][0].apply(r,arguments)},{"/Users/nolan/workspace/pouchdb/packages/pouchdb-promise":15,dup:10}],27:[function(e,t,r){!function(e){if("object"==typeof r)t.exports=e();else if("function"==typeof define&&define.amd)define(e);else{var n;try{n=window}catch(o){n=self}n.SparkMD5=e()}}(function(e){"use strict";function t(e,t,r,n,o,i){return t=_(_(t,e),_(n,i)),_(t<<o|t>>>32-o,r)}function r(e,r,n,o,i,s,a){return t(r&n|~r&o,e,r,i,s,a)}function n(e,r,n,o,i,s,a){return t(r&o|n&~o,e,r,i,s,a)}function o(e,r,n,o,i,s,a){
  return t(r^n^o,e,r,i,s,a)}function i(e,r,n,o,i,s,a){return t(n^(r|~o),e,r,i,s,a)}function s(e,t){var s=e[0],a=e[1],u=e[2],f=e[3];s=r(s,a,u,f,t[0],7,-680876936),f=r(f,s,a,u,t[1],12,-389564586),u=r(u,f,s,a,t[2],17,606105819),a=r(a,u,f,s,t[3],22,-1044525330),s=r(s,a,u,f,t[4],7,-176418897),f=r(f,s,a,u,t[5],12,1200080426),u=r(u,f,s,a,t[6],17,-1473231341),a=r(a,u,f,s,t[7],22,-45705983),s=r(s,a,u,f,t[8],7,1770035416),f=r(f,s,a,u,t[9],12,-1958414417),u=r(u,f,s,a,t[10],17,-42063),a=r(a,u,f,s,t[11],22,-1990404162),s=r(s,a,u,f,t[12],7,1804603682),f=r(f,s,a,u,t[13],12,-40341101),u=r(u,f,s,a,t[14],17,-1502002290),a=r(a,u,f,s,t[15],22,1236535329),s=n(s,a,u,f,t[1],5,-165796510),f=n(f,s,a,u,t[6],9,-1069501632),u=n(u,f,s,a,t[11],14,643717713),a=n(a,u,f,s,t[0],20,-373897302),s=n(s,a,u,f,t[5],5,-701558691),f=n(f,s,a,u,t[10],9,38016083),u=n(u,f,s,a,t[15],14,-660478335),a=n(a,u,f,s,t[4],20,-405537848),s=n(s,a,u,f,t[9],5,568446438),f=n(f,s,a,u,t[14],9,-1019803690),u=n(u,f,s,a,t[3],14,-187363961),a=n(a,u,f,s,t[8],20,1163531501),s=n(s,a,u,f,t[13],5,-1444681467),f=n(f,s,a,u,t[2],9,-51403784),u=n(u,f,s,a,t[7],14,1735328473),a=n(a,u,f,s,t[12],20,-1926607734),s=o(s,a,u,f,t[5],4,-378558),f=o(f,s,a,u,t[8],11,-2022574463),u=o(u,f,s,a,t[11],16,1839030562),a=o(a,u,f,s,t[14],23,-35309556),s=o(s,a,u,f,t[1],4,-1530992060),f=o(f,s,a,u,t[4],11,1272893353),u=o(u,f,s,a,t[7],16,-155497632),a=o(a,u,f,s,t[10],23,-1094730640),s=o(s,a,u,f,t[13],4,681279174),f=o(f,s,a,u,t[0],11,-358537222),u=o(u,f,s,a,t[3],16,-722521979),a=o(a,u,f,s,t[6],23,76029189),s=o(s,a,u,f,t[9],4,-640364487),f=o(f,s,a,u,t[12],11,-421815835),u=o(u,f,s,a,t[15],16,530742520),a=o(a,u,f,s,t[2],23,-995338651),s=i(s,a,u,f,t[0],6,-198630844),f=i(f,s,a,u,t[7],10,1126891415),u=i(u,f,s,a,t[14],15,-1416354905),a=i(a,u,f,s,t[5],21,-57434055),s=i(s,a,u,f,t[12],6,1700485571),f=i(f,s,a,u,t[3],10,-1894986606),u=i(u,f,s,a,t[10],15,-1051523),a=i(a,u,f,s,t[1],21,-2054922799),s=i(s,a,u,f,t[8],6,1873313359),f=i(f,s,a,u,t[15],10,-30611744),u=i(u,f,s,a,t[6],15,-1560198380),a=i(a,u,f,s,t[13],21,1309151649),s=i(s,a,u,f,t[4],6,-145523070),f=i(f,s,a,u,t[11],10,-1120210379),u=i(u,f,s,a,t[2],15,718787259),a=i(a,u,f,s,t[9],21,-343485551),e[0]=_(s,e[0]),e[1]=_(a,e[1]),e[2]=_(u,e[2]),e[3]=_(f,e[3])}function a(e){var t,r=[];for(t=0;64>t;t+=4)r[t>>2]=e.charCodeAt(t)+(e.charCodeAt(t+1)<<8)+(e.charCodeAt(t+2)<<16)+(e.charCodeAt(t+3)<<24);return r}function u(e){var t,r=[];for(t=0;64>t;t+=4)r[t>>2]=e[t]+(e[t+1]<<8)+(e[t+2]<<16)+(e[t+3]<<24);return r}function f(e){var t,r,n,o,i,u,f=e.length,c=[1732584193,-271733879,-1732584194,271733878];for(t=64;f>=t;t+=64)s(c,a(e.substring(t-64,t)));for(e=e.substring(t-64),r=e.length,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t=0;r>t;t+=1)n[t>>2]|=e.charCodeAt(t)<<(t%4<<3);if(n[t>>2]|=128<<(t%4<<3),t>55)for(s(c,n),t=0;16>t;t+=1)n[t]=0;return o=8*f,o=o.toString(16).match(/(.*?)(.{0,8})$/),i=parseInt(o[2],16),u=parseInt(o[1],16)||0,n[14]=i,n[15]=u,s(c,n),c}function c(e){var t,r,n,o,i,a,f=e.length,c=[1732584193,-271733879,-1732584194,271733878];for(t=64;f>=t;t+=64)s(c,u(e.subarray(t-64,t)));for(e=f>t-64?e.subarray(t-64):new Uint8Array(0),r=e.length,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t=0;r>t;t+=1)n[t>>2]|=e[t]<<(t%4<<3);if(n[t>>2]|=128<<(t%4<<3),t>55)for(s(c,n),t=0;16>t;t+=1)n[t]=0;return o=8*f,o=o.toString(16).match(/(.*?)(.{0,8})$/),i=parseInt(o[2],16),a=parseInt(o[1],16)||0,n[14]=i,n[15]=a,s(c,n),c}function h(e){var t,r="";for(t=0;4>t;t+=1)r+=b[e>>8*t+4&15]+b[e>>8*t&15];return r}function l(e){var t;for(t=0;t<e.length;t+=1)e[t]=h(e[t]);return e.join("")}function p(e){return/[\u0080-\uFFFF]/.test(e)&&(e=unescape(encodeURIComponent(e))),e}function d(e,t){var r,n=e.length,o=new ArrayBuffer(n),i=new Uint8Array(o);for(r=0;n>r;r+=1)i[r]=e.charCodeAt(r);return t?i:o}function y(e){return String.fromCharCode.apply(null,new Uint8Array(e))}function v(e,t,r){var n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e)),n.set(new Uint8Array(t),e.byteLength),r?n:n.buffer}function g(e){var t,r=[],n=e.length;for(t=0;n-1>t;t+=2)r.push(parseInt(e.substr(t,2),16));return String.fromCharCode.apply(String,r)}function m(){this.reset()}var _=function(e,t){return e+t&4294967295},b=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];return"5d41402abc4b2a76b9719d911017c592"!==l(f("hello"))&&(_=function(e,t){var r=(65535&e)+(65535&t),n=(e>>16)+(t>>16)+(r>>16);return n<<16|65535&r}),"undefined"==typeof ArrayBuffer||ArrayBuffer.prototype.slice||!function(){function t(e,t){return e=0|e||0,0>e?Math.max(e+t,0):Math.min(e,t)}ArrayBuffer.prototype.slice=function(r,n){var o,i,s,a,u=this.byteLength,f=t(r,u),c=u;return n!==e&&(c=t(n,u)),f>c?new ArrayBuffer(0):(o=c-f,i=new ArrayBuffer(o),s=new Uint8Array(i),a=new Uint8Array(this,f,o),s.set(a),i)}}(),m.prototype.append=function(e){return this.appendBinary(p(e)),this},m.prototype.appendBinary=function(e){this._buff+=e,this._length+=e.length;var t,r=this._buff.length;for(t=64;r>=t;t+=64)s(this._hash,a(this._buff.substring(t-64,t)));return this._buff=this._buff.substring(t-64),this},m.prototype.end=function(e){var t,r,n=this._buff,o=n.length,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;o>t;t+=1)i[t>>2]|=n.charCodeAt(t)<<(t%4<<3);return this._finish(i,o),r=l(this._hash),e&&(r=g(r)),this.reset(),r},m.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},m.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash}},m.prototype.setState=function(e){return this._buff=e.buff,this._length=e.length,this._hash=e.hash,this},m.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},m.prototype._finish=function(e,t){var r,n,o,i=t;if(e[i>>2]|=128<<(i%4<<3),i>55)for(s(this._hash,e),i=0;16>i;i+=1)e[i]=0;r=8*this._length,r=r.toString(16).match(/(.*?)(.{0,8})$/),n=parseInt(r[2],16),o=parseInt(r[1],16)||0,e[14]=n,e[15]=o,s(this._hash,e)},m.hash=function(e,t){return m.hashBinary(p(e),t)},m.hashBinary=function(e,t){var r=f(e),n=l(r);return t?g(n):n},m.ArrayBuffer=function(){this.reset()},m.ArrayBuffer.prototype.append=function(e){var t,r=v(this._buff.buffer,e,!0),n=r.length;for(this._length+=e.byteLength,t=64;n>=t;t+=64)s(this._hash,u(r.subarray(t-64,t)));return this._buff=n>t-64?new Uint8Array(r.buffer.slice(t-64)):new Uint8Array(0),this},m.ArrayBuffer.prototype.end=function(e){var t,r,n=this._buff,o=n.length,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;o>t;t+=1)i[t>>2]|=n[t]<<(t%4<<3);return this._finish(i,o),r=l(this._hash),e&&(r=g(r)),this.reset(),r},m.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},m.ArrayBuffer.prototype.getState=function(){var e=m.prototype.getState.call(this);return e.buff=y(e.buff),e},m.ArrayBuffer.prototype.setState=function(e){return e.buff=d(e.buff,!0),m.prototype.setState.call(this,e)},m.ArrayBuffer.prototype.destroy=m.prototype.destroy,m.ArrayBuffer.prototype._finish=m.prototype._finish,m.ArrayBuffer.hash=function(e,t){var r=c(new Uint8Array(e)),n=l(r);return t?g(n):n},m})},{}],28:[function(e,t,r){"use strict";function n(e,t,r){var n=r[r.length-1];e===n.element&&(r.pop(),n=r[r.length-1]);var o=n.element,i=n.index;if(Array.isArray(o))o.push(e);else if(i===t.length-2){var s=t.pop();o[s]=e}else t.push(e)}r.stringify=function(e){var t=[];t.push({obj:e});for(var r,n,o,i,s,a,u,f,c,h,l,p="";r=t.pop();)if(n=r.obj,o=r.prefix||"",i=r.val||"",p+=o,i)p+=i;else if("object"!=typeof n)p+="undefined"==typeof n?null:JSON.stringify(n);else if(null===n)p+="null";else if(Array.isArray(n)){for(t.push({val:"]"}),s=n.length-1;s>=0;s--)a=0===s?"":",",t.push({obj:n[s],prefix:a});t.push({val:"["})}else{u=[];for(f in n)n.hasOwnProperty(f)&&u.push(f);for(t.push({val:"}"}),s=u.length-1;s>=0;s--)c=u[s],h=n[c],l=s>0?",":"",l+=JSON.stringify(c)+":",t.push({obj:h,prefix:l});t.push({val:"{"})}return p},r.parse=function(e){for(var t,r,o,i,s,a,u,f,c,h=[],l=[],p=0;;)if(t=e[p++],"}"!==t&&"]"!==t&&"undefined"!=typeof t)switch(t){case" ":case"	":case"\n":case":":case",":break;case"n":p+=3,n(null,h,l);break;case"t":p+=3,n(!0,h,l);break;case"f":p+=4,n(!1,h,l);break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"-":for(r="",p--;;){if(o=e[p++],!/[\d\.\-e\+]/.test(o)){p--;break}r+=o}n(parseFloat(r),h,l);break;case'"':for(i="",s=void 0,a=0;;){if(u=e[p++],'"'===u&&("\\"!==s||a%2!==1))break;i+=u,s=u,"\\"===s?a++:a=0}n(JSON.parse('"'+i+'"'),h,l);break;case"[":f={element:[],index:h.length},h.push(f.element),l.push(f);break;case"{":c={element:{},index:h.length},h.push(c.element),l.push(c);break;default:throw new Error("unexpectedly reached end of input: "+t)}else{if(1===h.length)return h.pop();n(h.pop(),h,l)}}},{}]},{},[12]);

// testUtils.uuid
(function(){function getValue(a){return 0|Math.random()*a}function uuid(a,e){e=e||chars.length;var r="",t=-1;if(a){for(;++t<a;)r+=chars[getValue(e)];return r}for(;++t<36;)switch(t){case 8:case 13:case 18:case 23:r+="-";break;case 19:r+=chars[3&getValue(16)|8];break;default:r+=chars[getValue(16)]}return r}var chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");testUtils.uuid=uuid;})();

// testUtils.parseUri
(function(){function parseUri(r){for(var e=parser.exec(r),s={},a=14;a--;){var o=keys[a],t=e[a]||"",p=-1!==["user","password"].indexOf(o);s[o]=p?decodeURIComponent(t):t}return s[qName]={},s[keys[12]].replace(qParser,function(r,e,a){e&&(s[qName][e]=a)}),s}var keys=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],qName="queryKey",qParser=/(?:^|&)([^&=]*)=?([^&]*)/g,parser=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/;testUtils.parseUri=parseUri;})();



if (typeof module !== 'undefined' && module.exports) {
  global.PouchDB = require('../../packages/pouchdb');
  if (process.env.LEVEL_ADAPTER || process.env.LEVEL_PREFIX) {
    var defaults = {};

    if (process.env.LEVEL_ADAPTER) {
      defaults.db = require(process.env.LEVEL_ADAPTER);
      console.log('Using client-side leveldown adapter: ' +
        process.env.LEVEL_ADAPTER);
    }
    if (process.env.LEVEL_PREFIX) {
      defaults.prefix = process.env.LEVEL_PREFIX;
      console.log('Using client-side leveldown prefix: ' + defaults.prefix);
    }
    global.PouchDB = global.PouchDB.defaults(defaults);
  } else if (process.env.AUTO_COMPACTION) {
    global.PouchDB = global.PouchDB.defaults({auto_compaction: true});
  }
  if (typeof process !== 'undefined') {
    if (process.env.ADAPTER === 'websql') {
      // test WebSQL in Node
      require('../../packages/pouchdb/extras/websql');
      global.PouchDB.preferredAdapters = ['websql'];
      global.PouchDB.prefix = './tmp/' + global.PouchDB.prefix;
      require('mkdirp').sync('./tmp');
    } else {
      // test regular LevelDB in Node
      global.PouchDB.prefix = './tmp/' + global.PouchDB.prefix;
      global.PouchDB.adapters.leveldb.use_prefix = true;
    }
  }
  module.exports = testUtils;
}
